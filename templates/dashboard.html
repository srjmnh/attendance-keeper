{% extends "base.html" %}
{% block content %}
<h1 class="mb-4">Dashboard</h1>

<!-- Tabs -->
<ul class="nav nav-tabs" id="mainTabs" role="tablist">
    {% if role in ['admin', 'teacher'] %}
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab" aria-controls="register" aria-selected="true">Register</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="recognize-tab" data-bs-toggle="tab" data-bs-target="#recognize" type="button" role="tab" aria-controls="recognize" aria-selected="false">Recognize</button>
    </li>
    {% endif %}
    
    {% if role in ['admin', 'teacher'] %}
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="subjects-tab" data-bs-toggle="tab" data-bs-target="#subjects" type="button" role="tab" aria-controls="subjects" aria-selected="false">Subjects</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab" aria-controls="attendance" aria-selected="false">Attendance</button>
    </li>
    {% endif %}
    
    {% if role == 'admin' %}
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button" role="tab" aria-controls="admin" aria-selected="false">Admin</button>
    </li>
    {% endif %}
</ul>

<div class="tab-content" id="mainTabContent">
    <!-- REGISTER -->
    {% if role in ['admin', 'teacher'] %}
    <div class="tab-pane fade show active mt-4" id="register" role="tabpanel" aria-labelledby="register-tab">
        <h3>Register a Face</h3>
        <label class="form-label">Name</label>
        <input type="text" id="reg_name" class="form-control" placeholder="Enter Name" />
        <label class="form-label">Student ID</label>
        <input type="text" id="reg_student_id" class="form-control" placeholder="Enter Student ID" />
        <label class="form-label">Image</label>
        <input type="file" id="reg_image" class="form-control" accept="image/*" />
        <button onclick="registerFace()" class="btn btn-primary mt-2">Register</button>
        <div id="register_result" class="alert alert-info mt-3" style="display:none;"></div>
    </div>
    {% endif %}

    <!-- RECOGNIZE -->
    {% if role in ['admin', 'teacher', 'student'] %}
    <div class="tab-pane fade mt-4" id="recognize" role="tabpanel" aria-labelledby="recognize-tab">
        <h3>Recognize Attendance</h3>
        <label class="form-label">Name</label>
        <input type="text" id="rec_name" class="form-control" placeholder="Enter Name" />
        <label class="form-label">Student ID</label>
        <input type="text" id="rec_student_id" class="form-control" placeholder="Enter Student ID" />
        <label class="form-label">Class</label>
        <select id="rec_class" class="form-select mb-2">
            <option value="">-- Select Class --</option>
            {% for cls in classes %}
                <option value="{{ cls }}">{{ cls }}</option>
            {% endfor %}
        </select>
        <label class="form-label">Image</label>
        <input type="file" id="rec_image" class="form-control" accept="image/*" />
        <button onclick="recognizeAttendance()" class="btn btn-primary mt-2">Recognize</button>
        <div id="recognition_result" class="alert alert-info mt-3" style="display:none;"></div>
    </div>
    {% endif %}

    <!-- SUBJECTS -->
    {% if role in ['admin', 'teacher'] %}
    <div class="tab-pane fade mt-4" id="subjects" role="tabpanel" aria-labelledby="subjects-tab">
        <h3>Manage Subjects</h3>
        <table id="subjectsTable" class="table table-striped">
            <thead>
                <tr>
                    <th>Subject ID</th>
                    <th>Subject Name</th>
                    <th>Details</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for subject in subjects %}
                <tr>
                    <td>{{ subject.id }}</td>
                    <td contenteditable="true">{{ subject.name | default('') }}</td>
                    <td contenteditable="true">{{ subject.details | default('') }}</td>
                    <td>
                        <button class="btn btn-primary btn-sm save-subject" data-id="{{ subject.id }}">Save</button>
                        <button class="btn btn-danger btn-sm delete-subject" data-id="{{ subject.id }}">Delete</button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4">No subjects found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <h4 class="mt-4">Add New Subject</h4>
        <form id="addSubjectForm">
            <div class="mb-3">
                <label for="new_subject_name" class="form-label">Subject Name</label>
                <input type="text" class="form-control" id="new_subject_name" name="subject_name" required>
            </div>
            <div class="mb-3">
                <label for="new_subject_details" class="form-label">Details</label>
                <input type="text" class="form-control" id="new_subject_details" name="subject_details">
            </div>
            <button type="submit" class="btn btn-success">Add Subject</button>
        </form>

        <div id="subject_result" class="alert alert-info mt-3" style="display:none;"></div>
    </div>
    {% endif %}

    <!-- ATTENDANCE -->
    {% if role in ['admin', 'teacher'] %}
    <div class="tab-pane fade mt-4" id="attendance" role="tabpanel" aria-labelledby="attendance-tab">
        <h3>Attendance Records</h3>
        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label">Student ID</label>
                <input type="text" id="filter_student_id" class="form-control" placeholder="e.g. 1234" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Subject ID</label>
                <input type="text" id="filter_subject_id" class="form-control" placeholder="e.g. abc123" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Start Date</label>
                <input type="date" id="filter_start" class="form-control" />
            </div>
            <div class="col-md-3">
                <label class="form-label">End Date</label>
                <input type="date" id="filter_end" class="form-control" />
            </div>
        </div>
        <button class="btn btn-info mb-3" onclick="loadAttendance()">Apply Filters</button>
        <table id="attendanceTable" class="display table table-striped w-100">
            <thead>
                <tr>
                    <th>Doc ID</th>
                    <th>Student ID</th>
                    <th>Name</th>
                    <th>Subject ID</th>
                    <th>Subject Name</th>
                    <th>Timestamp</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="mt-3">
            <button class="btn btn-warning" onclick="saveEdits()">Save Changes</button>
            <button class="btn btn-secondary" onclick="downloadExcel()">Download Excel</button>
            <button class="btn btn-link" onclick="downloadTemplate()">Download Template</button>
            <label class="form-label d-block mt-3">Upload Excel (template must match columns):</label>
            <input type="file" id="excelFile" accept=".xlsx" class="form-control mb-2" />
            <button class="btn btn-dark" onclick="uploadExcel()">Upload Excel</button>
        </div>
    </div>
    {% endif %}

    <!-- Admin Panel -->
    {% if role == 'admin' %}
    <div class="tab-pane fade mt-4" id="admin" role="tabpanel" aria-labelledby="admin-tab">
        <h3>Admin Panel</h3>
        <h4>Manage Users</h4>
        <table id="usersTable" class="table table-striped">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Classes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.username | default('N/A') }}</td>
                    <td>{{ user.role | default('N/A') | capitalize }}</td>
                    <td>
                        {% if user.classes %}
                            {{ user.classes | join(", ") }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm edit-user" data-username="{{ user.username }}">Edit</button>
                        <button class="btn btn-danger btn-sm delete-user" data-username="{{ user.username }}">Delete</button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4">No users found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Edit User Modal -->
        <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="editUserForm">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="edit_username" name="username">
                            <div class="mb-3">
                                <label for="edit_role" class="form-label">Role</label>
                                <select class="form-select" id="edit_role" name="role" required>
                                    <option value="admin">Admin</option>
                                    <option value="teacher">Teacher</option>
                                    <option value="student">Student</option>
                                </select>
                            </div>
                            <div class="mb-3" id="edit_classes_div" style="display:none;">
                                <label for="edit_classes" class="form-label">Classes (comma-separated for Teachers)</label>
                                <input type="text" class="form-control" id="edit_classes" name="classes" placeholder="e.g. Physics101, Chemistry102">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Delete User Modal -->
        <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteUserModalLabel">Delete User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to delete user <strong id="delete_username"></strong>?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteUser">Delete</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="user_result" class="alert alert-info mt-3" style="display:none;"></div>
    </div>
    {% endif %}
</div>

<!-- Chatbot Toggle Button -->
<button id="chatbotToggle" class="btn btn-primary rounded-circle">💬</button>

<!-- Chatbot Window -->
<div id="chatbotWindow" class="card" style="position: fixed; bottom: 80px; right: 20px; width: 300px; max-height: 400px; display: none; flex-direction: column;">
    <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
        <span>Gemini Chat</span>
        <button class="btn btn-sm btn-light" id="chatCloseBtn">X</button>
    </div>
    <div class="card-body overflow-auto" id="chatMessages"></div>
    <div class="card-footer">
        <div class="input-group">
            <input type="text" id="chatInput" class="form-control" placeholder="Type a message..." />
            <button class="btn btn-primary" id="chatSendBtn">Send</button>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script>
    /* -------------- Chatbot Code -------------- */
    const toggleBtn = document.getElementById('chatbotToggle');
    const chatWindow = document.getElementById('chatbotWindow');
    const chatCloseBtn = document.getElementById('chatCloseBtn');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');

    // Toggle chat window
    toggleBtn.addEventListener('click', () => {
        if (chatWindow.style.display === 'none' || chatWindow.style.display === '') {
            chatWindow.style.display = 'flex';
        } else {
            chatWindow.style.display = 'none';
        }
    });

    // Close chat window
    chatCloseBtn.addEventListener('click', () => {
        chatWindow.style.display = 'none';
    });

    function sendMessage() {
        const userMessage = chatInput.value.trim();
        if (!userMessage) return;
        addMessage(userMessage, 'user');
        chatInput.value = '';

        fetch('/process_prompt', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: userMessage })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                addMessage("Error: " + data.error, 'assistant');
            } else {
                addMessage(data.message, 'assistant');
            }
        })
        .catch(err => {
            addMessage("Network or server error!", 'assistant');
            console.error(err);
        });
    }

    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.classList.add('message', sender);
        div.innerHTML = `<strong>${sender === 'user' ? 'You' : 'Gemini'}:</strong> ${text}`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    chatSendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });

    /* -------------- Register Face -------------- */
    function registerFace() {
        const name = document.getElementById('reg_name').value.trim();
        const studentId = document.getElementById('reg_student_id').value.trim();
        const file = document.getElementById('reg_image').files[0];
        if (!name || !studentId || !file) {
            alert('Please provide name, student ID, and an image.');
            return;
        }
        getBase64(file, (base64Str) => {
            fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, student_id: studentId, image: base64Str })
            })
            .then(res => res.json())
            .then(data => {
                const div = document.getElementById('register_result');
                div.style.display = 'block';
                div.textContent = data.message || data.error || JSON.stringify(data);
            })
            .catch(err => console.error(err));
        });
    }

    /* Recognize Faces */
    function recognizeAttendance() {
        const name = document.getElementById('rec_name').value.trim();
        const studentId = document.getElementById('rec_student_id').value.trim();
        const classId = document.getElementById('rec_class').value;
        const imageInput = document.getElementById('rec_image');
        if (imageInput.files.length === 0) {
            alert('Please upload an image.');
            return;
        }
        const file = imageInput.files[0];
        const reader = new FileReader();
        reader.onloadend = () => {
            const base64Image = reader.result;
            fetch('/recognize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, student_id: studentId, class_id: classId, image: base64Image })
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('recognition_result');
                if (data.error) {
                    resultDiv.className = 'alert alert-danger';
                    resultDiv.innerText = data.error;
                } else {
                    resultDiv.className = 'alert alert-success';
                    resultDiv.innerText = data.message;
                }
                resultDiv.style.display = 'block';
                setTimeout(() => { resultDiv.style.display = 'none'; }, 5000);
            })
            .catch(err => console.error(err));
        }
        reader.readAsDataURL(file);
    }

    function getBase64(file, callback) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => callback(reader.result);
        reader.onerror = (error) => console.error('Error:', error);
    }

    /* -------------- Admin Panel Scripts -------------- */
    // You can add AJAX calls here if needed for admin functionalities

    /* -------------- Attendance Management -------------- */
    let table;

    function loadAttendance() {
        const studentId = document.getElementById('filter_student_id').value.trim();
        const subjectId = document.getElementById('filter_subject_id').value.trim();
        const startDate = document.getElementById('filter_start').value;
        const endDate = document.getElementById('filter_end').value;

        let url = '/api/attendance?';
        if (studentId) url += 'student_id=' + studentId + '&';
        if (subjectId) url += 'subject_id=' + subjectId + '&';
        if (startDate) url += 'start_date=' + startDate + '&';
        if (endDate) url += 'end_date=' + endDate + '&';

        fetch(url)
            .then(res => res.json())
            .then(data => {
                populateAttendanceTable(data);
            })
            .catch(err => console.error(err));
    }

    function populateAttendanceTable(data) {
        if (table) {
            table.destroy();
        }
        const tbody = document.querySelector('#attendanceTable tbody');
        tbody.innerHTML = '';
        data.forEach(record => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${record.doc_id}</td>
                <td>${record.student_id}</td>
                <td>${record.name}</td>
                <td>${record.subject_id}</td>
                <td>${record.subject_name}</td>
                <td>${record.timestamp}</td>
                <td contenteditable="true">${record.status}</td>
            `;
            tbody.appendChild(tr);
        });
        table = $('#attendanceTable').DataTable();
    }

    function saveEdits() {
        const tbody = document.querySelector('#attendanceTable tbody');
        const rows = tbody.querySelectorAll('tr');
        let records = [];
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            records.push({
                doc_id: cells[0].textContent,
                student_id: cells[1].textContent,
                name: cells[2].textContent,
                subject_id: cells[3].textContent,
                subject_name: cells[4].textContent,
                timestamp: cells[5].textContent,
                status: cells[6].textContent
            });
        });
        fetch('/api/attendance/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ records })
        })
        .then(res => res.json())
        .then(resp => {
            alert(resp.message || resp.error || 'Attendance updated');
            loadAttendance();
        })
        .catch(err => console.error(err));
    }

    function downloadExcel() {
        const studentId = document.getElementById('filter_student_id').value.trim();
        const subjectId = document.getElementById('filter_subject_id').value.trim();
        const startDate = document.getElementById('filter_start').value;
        const endDate = document.getElementById('filter_end').value;

        let url = '/api/attendance/download?';
        if (studentId) url += 'student_id=' + studentId + '&';
        if (subjectId) url += 'subject_id=' + subjectId + '&';
        if (startDate) url += 'start_date=' + startDate + '&';
        if (endDate) url += 'end_date=' + endDate + '&';

        window.location.href = url;
    }

    function downloadTemplate() {
        window.location.href = '/api/attendance/template';
    }

    function uploadExcel() {
        const fileInput = document.getElementById('excelFile');
        if (!fileInput.files.length) {
            alert('Please select an Excel file (.xlsx)');
            return;
        }
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);

        fetch('/api/attendance/upload', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(resp => {
            alert(resp.message || resp.error || 'Excel uploaded');
            loadAttendance();
        })
        .catch(err => console.error(err));
    }

    document.addEventListener('DOMContentLoaded', () => {
        {% if role in ['admin', 'teacher'] %}
            {% if role == 'teacher' %}
                loadAttendance();  // Load attendance records on page load
            {% endif %}
            // Load subjects for Recognize tab if applicable
        {% endif %}
    });

    /* -------------- Subjects Management Scripts -------------- */
    $(document).ready(function() {
        $('#subjectsTable').DataTable();
        
        // Save Subject
        $('.save-subject').on('click', function() {
            const subjectId = $(this).data('id');
            const row = $(this).closest('tr');
            const name = row.find('td:nth-child(2)').text().trim();
            const details = row.find('td:nth-child(3)').text().trim();

            fetch(`/admin/update_subject/${subjectId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, details })
            })
            .then(res => res.json())
            .then(data => {
                $('#subject_result').removeClass().addClass(`alert alert-${data.status}`).text(data.message).show();
                setTimeout(() => $('#subject_result').hide(), 3000);
            })
            .catch(err => console.error(err));
        });

        // Delete Subject
        $('.delete-subject').on('click', function() {
            const subjectId = $(this).data('id');
            if (confirm('Are you sure you want to delete this subject?')) {
                fetch(`/admin/delete_subject/${subjectId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(res => res.json())
                .then(data => {
                    $('#subject_result').removeClass().addClass(`alert alert-${data.status}`).text(data.message).show();
                    setTimeout(() => $('#subject_result').hide(), 3000);
                    // Reload the table to reflect changes
                    location.reload();
                })
                .catch(err => console.error(err));
            }
        });

        // Add New Subject
        $('#addSubjectForm').on('submit', function(e) {
            e.preventDefault();
            const name = $('#new_subject_name').val().trim();
            const details = $('#new_subject_details').val().trim();

            fetch('/admin/add_subject', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, details })
            })
            .then(res => res.json())
            .then(data => {
                $('#subject_result').removeClass().addClass(`alert alert-${data.status}`).text(data.message).show();
                $('#addSubjectForm')[0].reset();
                setTimeout(() => $('#subject_result').hide(), 3000);
                // Reload the table to reflect changes
                location.reload();
            })
            .catch(err => console.error(err));
        });
    });

    /* -------------- User Management Scripts -------------- */
    $(document).ready(function() {
        $('#usersTable').DataTable();

        // Edit User
        $('.edit-user').on('click', function() {
            const username = $(this).data('username');
            // Fetch user details via API
            fetch(`/admin/get_user/${username}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        $('#edit_username').val(data.user.username);
                        $('#edit_role').val(data.user.role);
                        if (data.user.role === 'teacher') {
                            $('#edit_classes_div').show();
                            $('#edit_classes').val(data.user.classes.join(', '));
                        } else {
                            $('#edit_classes_div').hide();
                            $('#edit_classes').val('');
                        }
                        $('#editUserModal').modal('show');
                    } else {
                        alert(data.message);
                    }
                })
                .catch(err => console.error(err));
        });

        // Show/Hide classes input based on role in edit modal
        $('#edit_role').on('change', function() {
            const role = $(this).val();
            if (role === 'teacher') {
                $('#edit_classes_div').show();
            } else {
                $('#edit_classes_div').hide();
                $('#edit_classes').val('');
            }
        });

        // Handle Edit User Form Submission
        $('#editUserForm').on('submit', function(e) {
            e.preventDefault();
            const username = $('#edit_username').val();
            const role = $('#edit_role').val();
            const classes = $('#edit_classes').val().split(',').map(cls => cls.trim()).filter(cls => cls);

            fetch(`/admin/update_user/${username}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role, classes })
            })
            .then(response => response.json())
            .then(data => {
                $('#editUserModal').modal('hide');
                $('#user_result').removeClass().addClass(`alert alert-${data.status}`).text(data.message).show();
                setTimeout(() => $('#user_result').hide(), 3000);
                location.reload();
            })
            .catch(err => console.error(err));
        });

        // Delete User
        $('.delete-user').on('click', function() {
            const username = $(this).data('username');
            $('#delete_username').text(username);
            $('#deleteUserModal').modal('show');

            $('#confirmDeleteUser').off().on('click', function() {
                fetch(`/admin/delete_user/${username}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    $('#deleteUserModal').modal('hide');
                    $('#user_result').removeClass().addClass(`alert alert-${data.status}`).text(data.message).show();
                    setTimeout(() => $('#user_result').hide(), 3000);
                    location.reload();
                })
                .catch(err => console.error(err));
            });
        });
    });
</script>
{% endblock %} 
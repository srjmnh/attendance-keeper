{% extends "base.html" %}
{% block content %}
<h1 class="mb-4">Dashboard</h1>

<!-- Nav Tabs -->
<ul class="nav nav-tabs" id="mainTabs" role="tablist">
  {% if role in ['admin', 'teacher'] %}
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab" aria-controls="register" aria-selected="true">
      Register
    </button>
  </li>
  {% endif %}
  
  {% if role in ['admin', 'teacher', 'student'] %}
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="recognize-tab" data-bs-toggle="tab" data-bs-target="#recognize" type="button" role="tab" aria-controls="recognize" aria-selected="false">
      Recognize
    </button>
  </li>
  {% endif %}
  
  {% if role in ['admin', 'teacher'] %}
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="subjects-tab" data-bs-toggle="tab" data-bs-target="#subjects" type="button" role="tab" aria-controls="subjects" aria-selected="false">
      Subjects
    </button>
  </li>
  
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab" aria-controls="attendance" aria-selected="false">
      Attendance
    </button>
  </li>
  {% endif %}
  
  {% if role == 'admin' %}
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button" role="tab" aria-controls="admin" aria-selected="false">
      Admin
    </button>
  </li>
  {% endif %}
  
  <li class="nav-item ms-auto">
    <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
  </li>
</ul>

<div class="tab-content" id="mainTabsContent">
  {% if role in ['admin', 'teacher'] %}
  <!-- REGISTER -->
  <div class="tab-pane fade show active mt-4" id="register" role="tabpanel" aria-labelledby="register-tab">
    <h3>Register Student</h3>
    <div class="mb-3">
      <input type="text" id="name" class="form-control" placeholder="Enter Name">
    </div>
    <div class="mb-3">
      <input type="text" id="student_id" class="form-control" placeholder="Enter Student ID">
    </div>
    <div class="mb-3">
      <input type="file" id="register_image" class="form-control" accept="image/*">
    </div>
    <button onclick="registerUser()" class="btn btn-primary">Register</button>
    <div id="register_result" class="alert alert-info mt-3" style="display:none;"></div>
  </div>
  {% endif %}
  
  {% if role in ['admin', 'teacher', 'student'] %}
  <!-- RECOGNIZE -->
  <div class="tab-pane fade mt-4" id="recognize" role="tabpanel" aria-labelledby="recognize-tab">
    <h3>Recognize Faces</h3>
    {% if role != 'student' %}
    <label class="form-label">Subject (optional)</label>
    <select id="rec_subject_select" class="form-select mb-2">
      <option value="">-- No Subject --</option>
      {% for subject in subjects %}
        <option value="{{ subject.id }}">{{ subject.name }}</option>
      {% endfor %}
    </select>
    {% endif %}
    <label class="form-label">Image</label>
    <input type="file" id="rec_image" class="form-control" accept="image/*" />
    <button onclick="recognizeFace()" class="btn btn-success mt-2">Recognize</button>
    <div id="recognize_result" class="alert alert-info mt-3" style="display:none;"></div>
  </div>
  {% endif %}
  
  {% if role in ['admin', 'teacher'] %}
  <!-- SUBJECTS -->
  <div class="tab-pane fade mt-4" id="subjects" role="tabpanel" aria-labelledby="subjects-tab">
    <h3>Manage Subjects</h3>
    {% if role == 'admin' %}
    <div class="mb-3">
      <label for="subject_name" class="form-label">New Subject Name:</label>
      <div class="input-group">
        <input type="text" id="subject_name" class="form-control" placeholder="e.g. Mathematics" />
        <button onclick="addSubject()" class="btn btn-primary">Add Subject</button>
      </div>
    </div>
    {% endif %}
    <div id="subject_result" class="alert alert-info mt-3" style="display:none;"></div>
    
    <h5>Existing Subjects</h5>
    {% if role == 'admin' %}
    <table id="subjectsTable" class="display table table-striped" style="width:100%">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for subject in subjects %}
        <tr>
          <td>{{ subject.id }}</td>
          <td contenteditable="true">{{ subject.name }}</td>
          <td>
            <button onclick="deleteSubject('{{ subject.id }}')" class="btn btn-danger btn-sm">Delete</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <ul>
      {% for subject in subjects %}
        <li>{{ subject.name }}</li>
      {% endfor %}
    </ul>
    {% endif %}
  </div>
  
  <!-- ATTENDANCE -->
  <div class="tab-pane fade mt-4" id="attendance" role="tabpanel" aria-labelledby="attendance-tab">
    <h3>Attendance Records</h3>
    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">Student ID</label>
        <input type="text" id="filter_student_id" class="form-control" placeholder="e.g. 1234" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Subject ID</label>
        <input type="text" id="filter_subject_id" class="form-control" placeholder="e.g. abc123" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Start Date</label>
        <input type="date" id="filter_start" class="form-control" />
      </div>
      <div class="col-md-3">
        <label class="form-label">End Date</label>
        <input type="date" id="filter_end" class="form-control" />
      </div>
    </div>
    <button class="btn btn-info mb-3" onclick="loadAttendance()">Apply Filters</button>
    <table id="attendanceTable" class="display table table-striped w-100">
      <thead>
        <tr>
          <th>Doc ID</th>
          <th>Student ID</th>
          <th>Name</th>
          <th>Subject ID</th>
          <th>Subject Name</th>
          <th>Timestamp</th>
          <th>Status</th>
          <th>Recorded By</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="mt-3">
      <button class="btn btn-warning" onclick="saveEdits()">Save Changes</button>
      <button class="btn btn-secondary" onclick="downloadExcel()">Download Excel</button>
      <button class="btn btn-link" onclick="downloadTemplate()">Download Template</button>
      <label class="form-label d-block mt-3">Upload Excel (template must match columns):</label>
      <input type="file" id="excelFile" accept=".xlsx" class="form-control mb-2" />
      <button class="btn btn-dark" onclick="uploadExcel()">Upload Excel</button>
    </div>
  </div>
  {% endif %}
  
  {% if role == 'admin' %}
  <!-- ADMIN -->
  <div class="tab-pane fade mt-4" id="admin" role="tabpanel" aria-labelledby="admin-tab">
    <h3>Admin Panel</h3>
    <a href="{{ url_for('create_user') }}" class="btn btn-primary mb-3">Create User Account</a>
    
    <h4>Gemini AI Chat Commands</h4>
    <div class="mb-3">
      <label for="admin_prompt" class="form-label">Enter Command:</label>
      <input type="text" id="admin_prompt" class="form-control" placeholder="e.g. CREATE SUBJECT Biology" />
      <button onclick="sendAdminCommand()" class="btn btn-success mt-2">Send Command</button>
    </div>
    <div id="admin_chat_result" class="alert alert-info mt-3" style="display:none;"></div>
  </div>
  {% endif %}
</div>

<!-- Chatbot Toggle Button -->
<button id="chatbotToggle">ðŸ’¬</button>

<!-- Chatbot Window -->
<div id="chatbotWindow">
  <div id="chatHeader">
    <span>Gemini Chat</span>
    <button class="close-btn" id="chatCloseBtn">X</button>
  </div>
  <div id="chatMessages"></div>
  <div id="chatInputArea">
    <input type="text" id="chatInput" placeholder="Type a message..." />
    <button id="chatSendBtn">Send</button>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

<script src="{{ url_for('static', filename='script.js') }}"></script>
<script>
  $(document).ready(function() {
    // Initialize DataTable for Subjects if admin
    {% if role == 'admin' %}
    $('#subjectsTable').DataTable({
      "paging": false,
      "info": false
    });
    {% endif %}
    
    // Initialize DataTable for Attendance
    $('#attendanceTable').DataTable({
      "ajax": "/api/get_attendance_records",
      "columns": [
        { "data": "doc_id" },
        { "data": "student_id" },
        { "data": "name" },
        { "data": "subject_id" },
        { "data": "subject_name" },
        { "data": "timestamp" },
        { "data": "status" },
        { "data": "recorded_by" }
      ]
    });
  });
  
  // Chatbot Functionality
  document.getElementById('chatbotToggle').addEventListener('click', function() {
    document.getElementById('chatbotWindow').style.display = 'flex';
    this.style.display = 'none';
  });

  document.getElementById('chatCloseBtn').addEventListener('click', function() {
    document.getElementById('chatbotWindow').style.display = 'none';
    document.getElementById('chatbotToggle').style.display = 'flex';
  });

  document.getElementById('chatSendBtn').addEventListener('click', function() {
    const message = document.getElementById('chatInput').value.trim();
    if (message === "") return;
    
    // Display user's message
    const chatMessages = document.getElementById('chatMessages');
    const userMessage = document.createElement('div');
    userMessage.classList.add('message', 'user');
    userMessage.innerText = message;
    chatMessages.appendChild(userMessage);
    
    // Clear input
    document.getElementById('chatInput').value = '';
    
    // TODO: Send the message to the server and get a response
    // For demonstration, we'll echo the message
    setTimeout(() => {
      const assistantMessage = document.createElement('div');
      assistantMessage.classList.add('message', 'assistant');
      assistantMessage.innerText = "Echo: " + message;
      chatMessages.appendChild(assistantMessage);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 1000);
  });
</script>
{% endblock %} 
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Facial Recognition Attendance + Gemini Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 20px;
      font-family: 'Roboto', sans-serif;
      background-image: url('https://images.unsplash.com/photo-1503676260728-1c00da094a0b?auto=format&fit=crop&w=1950&q=80');
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
      color: #333;
    }
    .container {
      background-color: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 10px;
    }
    .nav-tabs .nav-link { color: #555; }
    .nav-tabs .nav-link.active { color: #000; font-weight: bold; }
    #attendanceTable td[contenteditable="true"] { background-color: #fcf8e3; }
    
    /* Chatbot Toggle Button */
    #chatbotToggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 999;
      background-color: #0d6efd;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    #chatbotToggle:hover { background-color: #0b5ed7; }
    
    /* Chat Window */
    #chatbotWindow {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 350px;
      max-height: 500px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background-color: #fff;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      z-index: 1000;
    }
    #chatHeader {
      background-color: #0d6efd;
      color: #fff;
      padding: 10px;
      border-radius: 10px 10px 0 0;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #chatHeader .close-btn {
      background: none;
      border: none;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      font-size: 18px;
    }
    #chatMessages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      font-size: 14px;
    }
    .message { margin-bottom: 10px; }
    .message.user { text-align: right; }
    .message.assistant { text-align: left; color: #333; }
    #chatInputArea {
      display: flex; border-top:1px solid #ddd;
    }
    #chatInput {
      flex: 1; padding:10px; border: none; outline: none; font-size: 14px;
    }
    #chatSendBtn {
      background-color: #0d6efd; color: #fff;
      border: none; padding: 0 20px; cursor: pointer;
    }
    #chatSendBtn:hover { background-color: #0b5ed7; }
    
    /* Progress Bar */
    .progress {
      height: 20px;
      margin-top: 10px;
      display: none;
    }
    
    /* Recognized Faces Display */
    #recognizedFaces {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    .face-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      width: 150px;
      text-align: center;
      background-color: #f9f9f9;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .face-card img {
      width: 100%;
      height: auto;
      border-radius: 5px;
    }
    .face-info {
      margin-top: 10px;
    }
    
    /* Modern Button Styles */
    .btn-primary, .btn-success, .btn-warning, .btn-danger {
      border-radius: 25px;
      padding: 10px 20px;
      font-weight: 500;
    }
    
    /* Editable Subjects */
    .editable-subject {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .editable-subject input {
      flex: 1;
      margin-right: 10px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1 class="text-center mb-4">Facial Recognition Attendance</h1>
  
  <!-- Nav Tabs -->
  <ul class="nav nav-tabs" id="mainTabs" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab">
        Register
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="recognize-tab" data-bs-toggle="tab" data-bs-target="#recognize" type="button" role="tab">
        Recognize
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="subjects-tab" data-bs-toggle="tab" data-bs-target="#subjects" type="button" role="tab">
        Subjects
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab">
        Attendance
      </button>
    </li>
  </ul>
  
  <div class="tab-content" id="mainTabContent">
    <!-- REGISTER -->
    <div class="tab-pane fade show active mt-4" id="register" role="tabpanel" aria-labelledby="register-tab">
      <h3>Register a Face</h3>
      <label class="form-label">Name</label>
      <input type="text" id="reg_name" class="form-control mb-2" placeholder="Enter Name" />
      <label class="form-label">Student ID</label>
      <input type="text" id="reg_student_id" class="form-control mb-2" placeholder="Enter Student ID" />
      <label class="form-label">Image</label>
      <input type="file" id="reg_image" class="form-control mb-2" accept="image/*" />
      <button onclick="registerFace()" class="btn btn-primary">Register</button>
      <div id="register_result" class="alert mt-3" style="display:none;"></div>
      
      <!-- Display Uploaded Image and Attendance Record -->
      <div id="registered_info" class="mt-4" style="display:none;">
        <h5>Registered Student:</h5>
        <img id="registered_image" src="" alt="Registered Image" class="img-fluid rounded" />
        <div id="registered_attendance" class="mt-2">
          <!-- Attendance Record Will Appear Here -->
        </div>
      </div>
    </div>
  
    <!-- RECOGNIZE -->
    <div class="tab-pane fade mt-4" id="recognize" role="tabpanel" aria-labelledby="recognize-tab">
      <h3>Recognize Faces</h3>
      <label class="form-label">Subject (optional)</label>
      <select id="rec_subject_select" class="form-control mb-2">
        <option value="">-- No Subject --</option>
      </select>
      <label class="form-label">Image</label>
      <input type="file" id="rec_image" class="form-control mb-2" accept="image/*" />
      <button onclick="recognizeFace()" class="btn btn-success">Recognize</button>
      
      <!-- Progress Bar -->
      <div class="progress">
        <div id="recognizeProgress" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
      </div>
      
      <div id="recognize_result" class="alert mt-3" style="display:none;"></div>
      
      <!-- Recognized Faces Display -->
      <div id="recognizedFaces"></div>
    </div>
  
    <!-- SUBJECTS -->
    <div class="tab-pane fade mt-4" id="subjects" role="tabpanel" aria-labelledby="subjects-tab">
      <h3>Manage Subjects</h3>
      <div class="mb-3">
        <label class="form-label">New Subject Name:</label>
        <input type="text" id="subject_name" class="form-control" placeholder="e.g. Mathematics" />
        <button onclick="addSubject()" class="btn btn-primary mt-2">Add Subject</button>
      </div>
      <div id="subject_result" class="alert mt-3" style="display:none;"></div>
      <hr />
      <h5>Existing Subjects</h5>
      <div id="subjects_list">
        <!-- Editable Subjects Will Appear Here -->
      </div>
    </div>
  
    <!-- ATTENDANCE -->
    <div class="tab-pane fade mt-4" id="attendance" role="tabpanel" aria-labelledby="attendance-tab">
      <h3>Attendance Records</h3>
      <div class="row mb-3">
        <div class="col-md-3">
          <label class="form-label">Student ID</label>
          <input type="text" id="filter_student_id" class="form-control" placeholder="e.g. 1234" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Subject ID</label>
          <input type="text" id="filter_subject_id" class="form-control" placeholder="e.g. abc123" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Start Date</label>
          <input type="date" id="filter_start" class="form-control" />
        </div>
        <div class="col-md-3">
          <label class="form-label">End Date</label>
          <input type="date" id="filter_end" class="form-control" />
        </div>
      </div>
      <button class="btn btn-info mb-3" onclick="loadAttendance()">Apply Filters</button>
      <table id="attendanceTable" class="display table table-striped w-100">
        <thead>
          <tr>
            <th>Doc ID</th>
            <th>Student ID</th>
            <th>Name</th>
            <th>Subject ID</th>
            <th>Subject Name</th>
            <th>Timestamp</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="mt-3">
        <button class="btn btn-warning" onclick="saveEdits()">Save Changes</button>
        <button class="btn btn-secondary" onclick="downloadExcel()">Download Excel</button>
        <button class="btn btn-link" onclick="downloadTemplate()">Download Template</button>
        <label class="form-label d-block mt-3">Upload Excel (template must match columns):</label>
        <input type="file" id="excelFile" accept=".xlsx" class="form-control mb-2" />
        <button class="btn btn-dark" onclick="uploadExcel()">Upload Excel</button>
      </div>
    </div>
  </div>
  
  <!-- Chatbot Toggle Button -->
  <button id="chatbotToggle">ðŸ’¬</button>
  
  <!-- Chatbot Window -->
  <div id="chatbotWindow" style="display:none; flex-direction:column;">
    <div id="chatHeader">
      <span>Gemini Chat</span>
      <button class="close-btn" id="chatCloseBtn">X</button>
    </div>
    <div id="chatMessages" style="flex:1; overflow-y:auto; padding:10px; font-size:14px;"></div>
    <div id="chatInputArea" style="display:flex; border-top:1px solid #ddd;">
      <input type="text" id="chatInput" placeholder="Type a message..." style="flex:1; padding:10px; border:none; outline:none; font-size:14px;" />
      <button id="chatSendBtn" style="background-color:#0d6efd; color:#fff; border:none; padding: 0 20px; cursor:pointer;">Send</button>
    </div>
  </div>
</div>

<!-- High-Quality Background Image (Optional) -->
<div style="display:none;">
  <img src="https://images.unsplash.com/photo-1503676260728-1c00da094a0b?auto=format&fit=crop&w=1950&q=80" alt="Background Image" />
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<!-- SocketIO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"
        integrity="sha512-Lu5VdC+PCsUwBrkgFVlrqe/tkKQ8cHgXLMi54nQVK3lfF1YbqA1cSYxUugwVxBAtzDdMx0A2Xb+ll96szm4vQw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
  /* -------------- Chatbot Code with SocketIO -------------- */
  const toggleBtn = document.getElementById('chatbotToggle');
  const chatWindow = document.getElementById('chatbotWindow');
  const chatCloseBtn = document.getElementById('chatCloseBtn');
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const chatSendBtn = document.getElementById('chatSendBtn');

  // Initialize SocketIO
  const socket = io();

  // Listen for assistant messages
  socket.on('assistant_reply', (data) => {
    addMessage(data.message, 'assistant');
  });

  // Toggle chat window
  toggleBtn.addEventListener('click', () => {
    if (chatWindow.style.display === 'none' || chatWindow.style.display === '') {
      chatWindow.style.display = 'flex';
    } else {
      chatWindow.style.display = 'none';
    }
  });

  // Close chat window
  chatCloseBtn.addEventListener('click', () => {
    chatWindow.style.display = 'none';
  });

  function sendMessage() {
    const userMessage = chatInput.value.trim();
    if (!userMessage) return;
    addMessage(userMessage, 'user');
    chatInput.value = '';

    // Show progress bar
    const progressBar = document.querySelector('.progress');
    const recognizeProgress = document.getElementById('recognizeProgress');
    progressBar.style.display = 'block';
    recognizeProgress.style.width = '0%';
    recognizeProgress.textContent = '0%';

    fetch('/process_prompt', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer your_secret_token_here'  // Replace with your actual token
      },
      body: JSON.stringify({ prompt: userMessage })
    })
    .then(res => res.json())
    .then(data => {
      // Hide progress bar
      progressBar.style.display = 'none';

      if (data.error) {
        addMessage("Error: " + data.error, 'assistant');
      }
      // Assistant's reply will be received via SocketIO
    })
    .catch(err => {
      // Hide progress bar
      progressBar.style.display = 'none';

      addMessage("Network or server error!", 'assistant');
      console.error(err);
    });
  }

  function addMessage(text, sender) {
    const div = document.createElement('div');
    div.classList.add('message', sender);
    div.textContent = text;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  chatSendBtn.addEventListener('click', sendMessage);
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendMessage();
    }
  });

  /* -------------- Register + Recognize + Subjects + Attendance -------------- */
  let table;
  let attendanceData = [];

  function getBase64(file, callback) {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => callback(reader.result);
    reader.onerror = (error) => console.error('Error:', error);
  }

  /* Register Face */
  function registerFace() {
    const name = document.getElementById('reg_name').value.trim();
    const studentId = document.getElementById('reg_student_id').value.trim();
    const file = document.getElementById('reg_image').files[0];
    if (!name || !studentId || !file) {
      alert('Please provide name, student ID, and an image.');
      return;
    }
    getBase64(file, (base64Str) => {
      fetch('/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer your_secret_token_here'  // Replace with your actual token
        },
        body: JSON.stringify({ name, student_id: studentId, image: base64Str })
      })
      .then(res => res.json())
      .then(data => {
        const div = document.getElementById('register_result');
        div.style.display = 'block';
        div.className = data.message.includes("successfully") ? "alert alert-success" : "alert alert-danger";
        div.textContent = data.message || data.error || JSON.stringify(data);

        if (data.photo) {
          // Display the uploaded photo
          document.getElementById('registered_image').src = data.photo;
          document.getElementById('registered_info').style.display = 'block';

          // Display the attendance record
          const attendanceDiv = document.getElementById('registered_attendance');
          attendanceDiv.innerHTML = `
            <p><strong>Name:</strong> ${name}</p>
            <p><strong>Student ID:</strong> ${studentId}</p>
            <p><strong>Status:</strong> PRESENT</p>
            <p><strong>Timestamp:</strong> ${new Date(data.timestamp).toLocaleString()}</p>
          `;
        }
      })
      .catch(err => console.error(err));
    });
  }

  /* Recognize Faces */
  function recognizeFace() {
    const file = document.getElementById('rec_image').files[0];
    const subjectId = document.getElementById('rec_subject_select').value;
    if (!file) {
      alert('Please select an image to recognize.');
      return;
    }
    getBase64(file, (base64Str) => {
      fetch('/recognize', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer your_secret_token_here'  // Replace with your actual token
        },
        body: JSON.stringify({ image: base64Str, subject_id: subjectId })
      })
      .then(res => res.json())
      .then(data => {
        const div = document.getElementById('recognize_result');
        div.style.display = 'block';
        div.className = "alert alert-info";
        let text = data.message || data.error || JSON.stringify(data);
        if (data.identified_people && data.identified_people.length > 0) {
          text += "<br/><br/>Identified People:<br/>";
          data.identified_people.forEach((p, index) => {
            text += `- Name: ${p.name || "Unknown"}, ID: ${p.student_id || "N/A"}, Confidence: ${p.confidence || "N/A"}%<br/>`;
          });
          div.innerHTML = text;

          // Display Recognized Faces
          displayRecognizedFaces(data.cropped_faces);
        } else {
          div.textContent = text;
        }
      })
      .catch(err => console.error(err));
    });
  }

  function displayRecognizedFaces(croppedFaces) {
    const facesDiv = document.getElementById('recognizedFaces');
    facesDiv.innerHTML = ''; // Clear previous faces
    croppedFaces.forEach((face, index) => {
      const faceCard = document.createElement('div');
      faceCard.classList.add('face-card');

      const img = document.createElement('img');
      img.src = face;  // Base64 image
      img.alt = `Face ${index + 1}`;
      faceCard.appendChild(img);

      facesDiv.appendChild(faceCard);
    });
  }

  /* Subjects */
  function addSubject() {
    const subjectName = document.getElementById('subject_name').value.trim();
    if (!subjectName) {
      alert('Please enter subject name.');
      return;
    }
    fetch('/add_subject', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer your_secret_token_here'  // Replace with your actual token
      },
      body: JSON.stringify({ subject_name: subjectName })
    })
    .then(res => res.json())
    .then(data => {
      const div = document.getElementById('subject_result');
      div.style.display = 'block';
      div.className = data.message.includes("successfully") ? "alert alert-success" : "alert alert-danger";
      div.textContent = data.message || data.error || JSON.stringify(data);
      document.getElementById('subject_name').value = '';
      loadSubjects();
    })
    .catch(err => console.error(err));
  }

  function loadSubjects() {
    fetch('/get_subjects', {
      headers: {
        'Authorization': 'Bearer your_secret_token_here'  // Replace with your actual token
      }
    })
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById('subjects_list');
      list.innerHTML = '';
      (data.subjects || []).forEach(sub => {
        const div = document.createElement('div');
        div.classList.add('editable-subject');
        
        const input = document.createElement('input');
        input.type = 'text';
        input.value = sub.name;
        input.id = `subject_${sub.id}`;
        
        const saveBtn = document.createElement('button');
        saveBtn.classList.add('btn', 'btn-sm', 'btn-success');
        saveBtn.textContent = 'Save';
        saveBtn.onclick = () => updateSubject(sub.id);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.classList.add('btn', 'btn-sm', 'btn-danger', 'ms-2');
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteSubject(sub.id);
        
        div.appendChild(input);
        div.appendChild(saveBtn);
        div.appendChild(deleteBtn);
        
        list.appendChild(div);
      });
    })
    .catch(err => console.error(err));
  }

  function updateSubject(subjectId) {
    const newName = document.getElementById(`subject_${subjectId}`).value.trim();
    if (!newName) {
      alert('Subject name cannot be empty.');
      return;
    }
    fetch('/update_subject', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer your_secret_token_here'  // Replace with your actual token
      },
      body: JSON.stringify({ subject_id: subjectId, new_name: newName })
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message || data.error || 'Subject updated.');
      loadSubjects();
    })
    .catch(err => console.error(err));
  }

  function deleteSubject(subjectId) {
    if (!confirm('Are you sure you want to delete this subject?')) return;
    fetch('/delete_subject', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer your_secret_token_here'  // Replace with your actual token
      },
      body: JSON.stringify({ subject_id: subjectId })
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message || data.error || 'Subject deleted.');
      loadSubjects();
    })
    .catch(err => console.error(err));
  }

  /* Attendance */
  function loadAttendance() {
    const studentId = document.getElementById('filter_student_id').value.trim();
    const subjectId = document.getElementById('filter_subject_id').value.trim();
    const startDate = document.getElementById('filter_start').value;
    const endDate = document.getElementById('filter_end').value;

    let url = '/api/attendance?';
    if (studentId) url += 'student_id=' + studentId + '&';
    if (subjectId) url += 'subject_id=' + subjectId + '&';
    if (startDate) url += 'start_date=' + startDate + '&';
    if (endDate) url += 'end_date=' + endDate + '&';

    fetch(url, {
      headers: {
        'Authorization': 'Bearer your_secret_token_here'  // Replace with your actual token
      }
    })
      .then(res => res.json())
      .then(data => {
        attendanceData = data;
        renderAttendanceTable(attendanceData);
      })
      .catch(err => console.error(err));
  }

  function renderAttendanceTable(data) {
    if ($.fn.DataTable.isDataTable('#attendanceTable')) {
      $('#attendanceTable').DataTable().clear().destroy();
    }
    const tbody = document.querySelector('#attendanceTable tbody');
    tbody.innerHTML = '';
    data.forEach(record => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${record.doc_id || ''}</td>
        <td contenteditable="true">${record.student_id || ''}</td>
        <td contenteditable="true">${record.name || ''}</td>
        <td contenteditable="true">${record.subject_id || ''}</td>
        <td contenteditable="true">${record.subject_name || ''}</td>
        <td contenteditable="true">${new Date(record.timestamp).toLocaleString() || ''}</td>
        <td contenteditable="true">${record.status || ''}</td>
      `;
      tbody.appendChild(row);
    });
    $('#attendanceTable').DataTable({
      paging: true,
      searching: false,
      info: false,
      responsive: true
    });
  }

  function saveEdits() {
    const rows = document.querySelectorAll('#attendanceTable tbody tr');
    const updatedRecords = [];
    rows.forEach(row => {
      const cells = row.querySelectorAll('td');
      const doc_id = cells[0].textContent.trim();
      const student_id = cells[1].textContent.trim();
      const name = cells[2].textContent.trim();
      const subject_id = cells[3].textContent.trim();
      const subject_name = cells[4].textContent.trim();
      const timestamp = cells[5].textContent.trim();
      const status = cells[6].textContent.trim();
      updatedRecords.push({ doc_id, student_id, name, subject_id, subject_name, timestamp, status });
    });
    fetch('/api/attendance/update', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer your_secret_token_here'  // Replace with your actual token
      },
      body: JSON.stringify({ records: updatedRecords })
    })
    .then(res => res.json())
    .then(resp => {
      alert(resp.message || JSON.stringify(resp));
      loadAttendance();
    })
    .catch(err => console.error(err));
  }

  function downloadExcel() {
    const studentId = document.getElementById('filter_student_id').value.trim();
    const subjectId = document.getElementById('filter_subject_id').value.trim();
    const startDate = document.getElementById('filter_start').value;
    const endDate = document.getElementById('filter_end').value;

    let url = '/api/attendance/download?';
    if (studentId) url += 'student_id=' + studentId + '&';
    if (subjectId) url += 'subject_id=' + subjectId + '&';
    if (startDate) url += 'start_date=' + startDate + '&';
    if (endDate) url += 'end_date=' + endDate + '&';

    window.location.href = url;
  }

  function downloadTemplate() {
    window.location.href = '/api/attendance/template';
  }

  function uploadExcel() {
    const fileInput = document.getElementById('excelFile');
    if (!fileInput.files.length) {
      alert('Please select an Excel file (.xlsx)');
      return;
    }
    const file = fileInput.files[0];
    const formData = new FormData();
    formData.append('file', file);

    fetch('/api/attendance/upload', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer your_secret_token_here'  // Replace with your actual token
      },
      body: formData
    })
    .then(res => res.json())
    .then(resp => {
      alert(resp.message || resp.error || 'Excel uploaded');
      loadAttendance();
    })
    .catch(err => console.error(err));
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadSubjects();
  });
</script>
</body>
</html>

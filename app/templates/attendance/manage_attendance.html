{% extends "base.html" %}

{% block title %}Manage Attendance - Attendance System{% endblock %}

{% block extra_css %}
<style>
    .attendance-card {
        transition: transform 0.2s;
    }
    .attendance-card:hover {
        transform: translateY(-2px);
    }
    .subject-info {
        font-size: 0.9rem;
    }
    .attendance-stats {
        font-size: 0.85rem;
    }
    .student-list {
        max-height: 400px;
        overflow-y: auto;
    }
    .student-item {
        transition: background-color 0.2s;
    }
    .student-item:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    .student-avatar {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 50%;
    }
    .attendance-history {
        max-height: 300px;
        overflow-y: auto;
    }
    .chart-container {
        height: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Manage Attendance</h1>
        <div>
            <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#generateReportModal">
                <i class="fas fa-file-alt"></i> Generate Report
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#takeAttendanceModal">
                <i class="fas fa-camera"></i> Take Attendance
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="filterForm" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Subject</label>
                    <select class="form-select" name="subject_id">
                        <option value="">All Subjects</option>
                        {% for subject in subjects %}
                        <option value="{{ subject.id }}">{{ subject.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Date Range</label>
                    <select class="form-select" name="date_range">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div class="col-md-4 custom-date-range" style="display: none;">
                    <div class="row">
                        <div class="col-6">
                            <label class="form-label">From</label>
                            <input type="date" class="form-control" name="date_from">
                        </div>
                        <div class="col-6">
                            <label class="form-label">To</label>
                            <input type="date" class="form-control" name="date_to">
                        </div>
                    </div>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-3">Total Students</h6>
                    <div class="d-flex align-items-center">
                        <div class="display-4 me-3">{{ total_students }}</div>
                        <div class="text-success">
                            <i class="fas fa-arrow-up"></i>
                            <small>+{{ new_students }} new</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-3">Average Attendance</h6>
                    <div class="d-flex align-items-center">
                        <div class="display-4 me-3">{{ avg_attendance }}%</div>
                        <div class="text-{{ 'success' if avg_attendance >= 75 else 'danger' }}">
                            <i class="fas fa-{{ 'arrow-up' if avg_attendance >= 75 else 'arrow-down' }}"></i>
                            <small>{{ '+' if avg_attendance >= 75 else '' }}{{ avg_attendance - 75 }}%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-3">Today's Classes</h6>
                    <div class="d-flex align-items-center">
                        <div class="display-4 me-3">{{ todays_classes }}</div>
                        <div class="text-muted">
                            <small>{{ completed_classes }} completed</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-3">Pending Attendance</h6>
                    <div class="d-flex align-items-center">
                        <div class="display-4 me-3">{{ pending_attendance }}</div>
                        <div class="text-warning">
                            <i class="fas fa-clock"></i>
                            <small>needs action</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance History -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recent Attendance Records</h5>
                </div>
                <div class="card-body">
                    <div class="attendance-history">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Subject</th>
                                        <th>Present</th>
                                        <th>Absent</th>
                                        <th>Rate</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in attendance_records %}
                                    <tr>
                                        <td>{{ record.date }}</td>
                                        <td>{{ record.subject_name }}</td>
                                        <td class="text-success">{{ record.present_count }}</td>
                                        <td class="text-danger">{{ record.absent_count }}</td>
                                        <td>
                                            <div class="progress" style="height: 6px; width: 100px;">
                                                <div class="progress-bar bg-success" role="progressbar" 
                                                     style="width: {{ record.attendance_rate }}%"></div>
                                            </div>
                                            <small class="text-muted">{{ record.attendance_rate }}%</small>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="viewAttendanceDetails('{{ record.id }}')" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-warning" onclick="editAttendance('{{ record.id }}')" title="Edit Attendance">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Attendance Trends</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="attendanceTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Take Attendance Modal -->
<div class="modal fade" id="takeAttendanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Take Attendance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Subject</label>
                        <select class="form-select" id="attendanceSubject" required>
                            <option value="">Select Subject</option>
                            {% for subject in subjects %}
                            <option value="{{ subject.id }}">{{ subject.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="attendanceDate" required>
                    </div>
                </div>
                <div class="text-center mb-3">
                    <button class="btn btn-primary" onclick="startCamera()">
                        <i class="fas fa-camera"></i> Start Camera
                    </button>
                </div>
                <div class="camera-container text-center mb-3" style="display: none;">
                    <video id="cameraFeed" style="max-width: 100%; height: 300px;" autoplay></video>
                    <canvas id="captureCanvas" style="display: none;"></canvas>
                    <div class="mt-2">
                        <button class="btn btn-success" onclick="captureImage()">
                            <i class="fas fa-camera"></i> Capture
                        </button>
                        <button class="btn btn-danger" onclick="stopCamera()">
                            <i class="fas fa-times"></i> Stop Camera
                        </button>
                    </div>
                </div>
                <div class="recognition-results" style="display: none;">
                    <h6>Recognized Students</h6>
                    <div class="student-list">
                        <!-- Students will be added here dynamically -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveAttendance()">Save Attendance</button>
            </div>
        </div>
    </div>
</div>

<!-- Generate Report Modal -->
<div class="modal fade" id="generateReportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generate Attendance Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <div class="mb-3">
                        <label class="form-label">Report Type</label>
                        <select class="form-select" name="report_type" required>
                            <option value="daily">Daily Report</option>
                            <option value="weekly">Weekly Report</option>
                            <option value="monthly">Monthly Report</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subject</label>
                        <select class="form-select" name="subject_id">
                            <option value="">All Subjects</option>
                            {% for subject in subjects %}
                            <option value="{{ subject.id }}">{{ subject.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="custom-range-fields" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">From Date</label>
                            <input type="date" class="form-control" name="date_from">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">To Date</label>
                            <input type="date" class="form-control" name="date_to">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Format</label>
                        <select class="form-select" name="format" required>
                            <option value="pdf">PDF</option>
                            <option value="excel">Excel</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="generateReport()">Generate Report</button>
            </div>
        </div>
    </div>
</div>

<!-- View Attendance Details Modal -->
<div class="modal fade" id="viewAttendanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Attendance Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="subject-info mb-3">
                    <h6 class="text-muted">Subject Information</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Subject:</strong> <span id="detailSubject"></span></p>
                            <p><strong>Date:</strong> <span id="detailDate"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Teacher:</strong> <span id="detailTeacher"></span></p>
                            <p><strong>Time:</strong> <span id="detailTime"></span></p>
                        </div>
                    </div>
                </div>
                <div class="student-list">
                    <h6 class="text-muted">Student List</h6>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>ID</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody id="detailStudentList">
                                <!-- Students will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize attendance trend chart
const ctx = document.getElementById('attendanceTrendChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ trend_labels|tojson }},
        datasets: [{
            label: 'Attendance Rate',
            data: {{ trend_data|tojson }},
            borderColor: '#0d6efd',
            tension: 0.1,
            fill: false
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: value => value + '%'
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Toggle custom date range fields
document.querySelector('[name="date_range"]').addEventListener('change', function(event) {
    const customFields = document.querySelector('.custom-date-range');
    customFields.style.display = event.target.value === 'custom' ? 'block' : 'none';
});

// Toggle custom range fields in report form
document.querySelector('[name="report_type"]').addEventListener('change', function(event) {
    const customFields = document.querySelector('.custom-range-fields');
    customFields.style.display = event.target.value === 'custom' ? 'block' : 'none';
});

// Camera handling
let stream = null;
let recognizedStudents = new Set();

async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const video = document.getElementById('cameraFeed');
        video.srcObject = stream;
        document.querySelector('.camera-container').style.display = 'block';
    } catch (error) {
        utils.showToast('Error accessing camera: ' + error.message, 'danger');
    }
}

function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
        document.querySelector('.camera-container').style.display = 'none';
    }
}

async function captureImage() {
    const video = document.getElementById('cameraFeed');
    const canvas = document.getElementById('captureCanvas');
    const context = canvas.getContext('2d');
    
    // Set canvas dimensions to match video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // Draw video frame to canvas
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Get image data
    const imageData = canvas.toDataURL('image/jpeg');
    
    try {
        // Send image for recognition
        const response = await fetch('/api/attendance/recognize', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image: imageData,
                subject_id: document.getElementById('attendanceSubject').value
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            updateRecognitionResults(result.students);
        } else {
            throw new Error('Failed to recognize students');
        }
    } catch (error) {
        utils.showToast(error.message, 'danger');
    }
}

function updateRecognitionResults(students) {
    const container = document.querySelector('.recognition-results');
    const list = container.querySelector('.student-list');
    container.style.display = 'block';
    
    students.forEach(student => {
        if (!recognizedStudents.has(student.id)) {
            recognizedStudents.add(student.id);
            const item = document.createElement('div');
            item.className = 'student-item d-flex align-items-center p-2 border-bottom';
            item.innerHTML = `
                <img src="${student.avatar_url || '/static/img/default-avatar.png'}" 
                     alt="${student.name}" class="student-avatar me-3">
                <div>
                    <div class="fw-bold">${student.name}</div>
                    <small class="text-muted">ID: ${student.student_id}</small>
                </div>
                <div class="ms-auto">
                    <span class="badge bg-success">Present</span>
                </div>
            `;
            list.appendChild(item);
        }
    });
}

async function saveAttendance() {
    const subjectId = document.getElementById('attendanceSubject').value;
    const date = document.getElementById('attendanceDate').value;
    
    if (!subjectId || !date) {
        utils.showToast('Please select subject and date', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/attendance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                subject_id: subjectId,
                date: date,
                students: Array.from(recognizedStudents)
            })
        });
        
        if (response.ok) {
            utils.showToast('Attendance saved successfully', 'success');
            location.reload();
        } else {
            throw new Error('Failed to save attendance');
        }
    } catch (error) {
        utils.showToast(error.message, 'danger');
    }
}

async function viewAttendanceDetails(recordId) {
    try {
        const response = await fetch(`/api/attendance/${recordId}`);
        const record = await response.json();
        
        // Update modal content
        document.getElementById('detailSubject').textContent = record.subject_name;
        document.getElementById('detailDate').textContent = record.date;
        document.getElementById('detailTeacher').textContent = record.teacher_name;
        document.getElementById('detailTime').textContent = record.time;
        
        const studentList = document.getElementById('detailStudentList');
        studentList.innerHTML = record.students.map(student => `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <img src="${student.avatar_url || '/static/img/default-avatar.png'}" 
                             alt="${student.name}" class="student-avatar me-2" style="width: 32px; height: 32px;">
                        <div>${student.name}</div>
                    </div>
                </td>
                <td>${student.student_id}</td>
                <td>
                    <span class="badge bg-${student.status === 'present' ? 'success' : 'danger'}">
                        ${student.status}
                    </span>
                </td>
                <td>${student.time}</td>
            </tr>
        `).join('');
        
        new bootstrap.Modal(document.getElementById('viewAttendanceModal')).show();
    } catch (error) {
        utils.showToast('Error loading attendance details', 'danger');
    }
}

async function editAttendance(recordId) {
    window.location.href = `/attendance/edit/${recordId}`;
}

async function generateReport() {
    const form = document.getElementById('reportForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/api/attendance/report', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_report.${formData.get('format')}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            utils.showToast('Report generated successfully', 'success');
        } else {
            throw new Error('Failed to generate report');
        }
    } catch (error) {
        utils.showToast(error.message, 'danger');
    }
}

// Filter form submission
document.getElementById('filterForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const params = new URLSearchParams(formData);
    window.location.href = `${window.location.pathname}?${params.toString()}`;
});

// Cleanup
window.addEventListener('beforeunload', () => {
    stopCamera();
});
</script>
{% endblock %} 
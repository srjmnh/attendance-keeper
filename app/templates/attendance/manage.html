{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-md p-6">
        <!-- Header with Export/Import Options -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-900">Attendance Management</h1>
            
            {% if current_user.role in ['admin', 'teacher'] %}
            <div class="flex space-x-4">
                <button onclick="downloadTemplate()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                    Download Template
                </button>
                <button onclick="document.getElementById('upload_excel').click()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                    Upload Excel
                </button>
                <input type="file" id="upload_excel" accept=".xlsx,.xls" class="hidden" onchange="uploadExcel(this)">
                <button onclick="downloadAttendance()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors">
                    Export to Excel
                </button>
            </div>
            {% endif %}
        </div>
        
        <!-- Filters -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                <select id="date_filter" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                <select id="subject_filter" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    <option value="">All Subjects</option>
                    {% for subject in subjects %}
                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="status_filter" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    <option value="">All Status</option>
                    <option value="PRESENT">Present</option>
                    <option value="ABSENT">Absent</option>
                    <option value="LATE">Late</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input type="text" id="search_filter" placeholder="Search by name or ID..." class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
        </div>
        
        <!-- Custom Date Range (hidden by default) -->
        <div id="custom_date_range" class="grid grid-cols-2 gap-4 mb-6 hidden">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">From</label>
                <input type="date" id="date_from" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">To</label>
                <input type="date" id="date_to" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
        </div>

        <!-- Save Changes Button (Admin Only) -->
        {% if current_user.role == 'admin' %}
        <div class="mb-4">
            <button onclick="saveAllChanges()" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition-colors">
                Save All Changes
            </button>
        </div>
        {% endif %}
        
        <!-- Attendance Table -->
        <div class="overflow-x-auto">
            <table id="attendanceTable" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        {% if current_user.role == 'admin' %}
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="attendance_table">
                </tbody>
            </table>
        </div>

        <!-- AI Analysis Section -->
        <div class="mt-8 bg-gray-50 p-6 rounded-lg">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">AI Insights</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Attendance Analysis</h3>
                    <div id="ai_analysis" class="bg-white p-4 rounded-md shadow-sm">
                        <p class="text-gray-600">Select a student to view AI analysis</p>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Recommendations</h3>
                    <div id="ai_recommendations" class="bg-white p-4 rounded-md shadow-sm">
                        <p class="text-gray-600">Select a student to view recommendations</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
let attendanceTable;
let editedRows = new Set();

document.addEventListener('DOMContentLoaded', function() {
    // Initialize DataTable
    attendanceTable = new DataTable('#attendanceTable', {
        ajax: {
            url: '/api/attendance',
            dataSrc: ''
        },
        columns: [
            { 
                data: 'timestamp',
                render: function(data) {
                    return new Date(data).toLocaleString();
                }
            },
            { 
                data: 'name',
                render: function(data, type, row) {
                    if (type === 'display' && '{{ current_user.role }}' === 'admin') {
                        return `<input type="text" class="border-b border-gray-300 focus:border-indigo-500 focus:ring-0 bg-transparent" value="${data}" onchange="markRowAsEdited('${row.doc_id}')">`;
                    }
                    return data;
                }
            },
            { data: 'student_id' },
            { data: 'subject_name' },
            {
                data: 'status',
                render: function(data, type, row) {
                    if (type === 'display' && '{{ current_user.role }}' === 'admin') {
                        return `
                            <select class="border-0 bg-transparent focus:ring-0" onchange="markRowAsEdited('${row.doc_id}')">
                                <option value="PRESENT" ${data === 'PRESENT' ? 'selected' : ''}>Present</option>
                                <option value="ABSENT" ${data === 'ABSENT' ? 'selected' : ''}>Absent</option>
                                <option value="LATE" ${data === 'LATE' ? 'selected' : ''}>Late</option>
                            </select>`;
                    }
                    return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                        ${data === 'PRESENT' ? 'bg-green-100 text-green-800' : 
                          data === 'ABSENT' ? 'bg-red-100 text-red-800' : 
                          'bg-yellow-100 text-yellow-800'}">${data}</span>`;
                }
            },
            {% if current_user.role == 'admin' %}
            {
                data: null,
                render: function(data, type, row) {
                    return `
                        <button onclick="deleteRecord('${row.doc_id}')" class="text-red-600 hover:text-red-900">Delete</button>`;
                }
            }
            {% endif %}
        ],
        order: [[0, 'desc']],
        pageLength: 25,
        responsive: true
    });

    // Event listeners for filters
    document.getElementById('date_filter').addEventListener('change', function() {
        const customRange = document.getElementById('custom_date_range');
        customRange.classList.toggle('hidden', this.value !== 'custom');
        applyFilters();
    });

    ['subject_filter', 'status_filter', 'date_from', 'date_to'].forEach(id => {
        document.getElementById(id).addEventListener('change', applyFilters);
    });

    document.getElementById('search_filter').addEventListener('input', debounce(applyFilters, 300));
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function markRowAsEdited(docId) {
    editedRows.add(docId);
}

function applyFilters() {
    const filters = {
        date_range: document.getElementById('date_filter').value,
        subject: document.getElementById('subject_filter').value,
        status: document.getElementById('status_filter').value,
        search: document.getElementById('search_filter').value,
        date_from: document.getElementById('date_from').value,
        date_to: document.getElementById('date_to').value
    };
    
    const queryString = new URLSearchParams(filters).toString();
    attendanceTable.ajax.url(`/api/attendance?${queryString}`).load();
}

async function saveAllChanges() {
    if (editedRows.size === 0) {
        alert('No changes to save');
        return;
    }

    const changes = [];
    editedRows.forEach(docId => {
        const row = attendanceTable.row(`[data-doc-id="${docId}"]`);
        const data = row.data();
        const cells = row.nodes().to$().find('input, select');
        
        changes.push({
            doc_id: docId,
            name: cells.eq(0).val(),
            status: cells.eq(1).val(),
            ...data
        });
    });

    try {
        const response = await fetch('/api/attendance/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ records: changes })
        });
        
        const result = await response.json();
        if (response.ok) {
            alert('Changes saved successfully');
            editedRows.clear();
            applyFilters();
        } else {
            alert(result.error || 'Failed to save changes');
        }
    } catch (error) {
        alert('Error saving changes');
        console.error('Error:', error);
    }
}

async function deleteRecord(docId) {
    if (!confirm('Are you sure you want to delete this record?')) return;
    
    try {
        const response = await fetch(`/api/attendance/${docId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('Record deleted successfully');
            applyFilters();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to delete record');
        }
    } catch (error) {
        alert('Error deleting record');
        console.error('Error:', error);
    }
}

function downloadTemplate() {
    window.location.href = '/api/attendance/template';
}

async function uploadExcel(input) {
    const file = input.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch('/api/attendance/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        if (response.ok) {
            alert('Upload successful');
            applyFilters();
        } else {
            alert(data.error || 'Upload failed');
        }
    } catch (error) {
        alert('Error uploading file');
        console.error('Error:', error);
    }
}

function downloadAttendance() {
    const filters = {
        date_range: document.getElementById('date_filter').value,
        subject: document.getElementById('subject_filter').value,
        status: document.getElementById('status_filter').value,
        search: document.getElementById('search_filter').value,
        date_from: document.getElementById('date_from').value,
        date_to: document.getElementById('date_to').value
    };
    
    const queryString = new URLSearchParams(filters).toString();
    window.location.href = `/api/attendance/export?${queryString}`;
}

// AI Analysis Functions
async function getAIAnalysis(studentId) {
    try {
        const response = await fetch('/api/ai/analyze-attendance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ student_id: studentId })
        });
        
        const data = await response.json();
        if (response.ok) {
            document.getElementById('ai_analysis').innerHTML = data.analysis;
        } else {
            document.getElementById('ai_analysis').innerHTML = data.error || 'Failed to get AI analysis';
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('ai_analysis').innerHTML = 'Error getting AI analysis';
    }
}

async function getAIRecommendations(studentId) {
    try {
        const response = await fetch('/api/ai/get-recommendations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ student_id: studentId })
        });
        
        const data = await response.json();
        if (response.ok) {
            document.getElementById('ai_recommendations').innerHTML = data.recommendations;
        } else {
            document.getElementById('ai_recommendations').innerHTML = data.error || 'Failed to get recommendations';
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('ai_recommendations').innerHTML = 'Error getting recommendations';
    }
}
</script>
{% endblock %} 
{% extends "base.html" %}

{% block title %}Dashboard - AttendanceAI{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Total Students -->
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-primary">
                    <i class="ri-user-line text-3xl"></i>
                </div>
                <div class="stat-title">Total Students</div>
                <div class="stat-value text-primary">{{ total_students }}</div>
            </div>
        </div>
        
        <!-- Total Subjects -->
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-secondary">
                    <i class="ri-book-line text-3xl"></i>
                </div>
                <div class="stat-title">Total Subjects</div>
                <div class="stat-value text-secondary">{{ total_subjects }}</div>
            </div>
        </div>
        
        <!-- Today's Attendance -->
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-accent">
                    <i class="ri-calendar-check-line text-3xl"></i>
                </div>
                <div class="stat-title">Today's Attendance</div>
                <div class="stat-value text-accent">{{ today_attendance }}%</div>
                <div class="stat-desc">{{ attendance_trend }}</div>
            </div>
        </div>
        
        <!-- Recognition Status -->
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-success">
                    <i class="ri-face-recognition-line text-3xl"></i>
                </div>
                <div class="stat-title">Recognition Status</div>
                <div class="stat-value text-success" id="recognitionStatus">Ready</div>
                <div class="stat-desc" id="recognitionProgress"></div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Attendance Chart -->
        <div class="card bg-base-100 shadow-lg lg:col-span-2">
            <div class="card-body">
                <h2 class="card-title flex items-center gap-2">
                    <i class="ri-line-chart-line text-primary"></i>
                    Attendance Trend
                </h2>
                <div class="h-[300px]">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title flex items-center gap-2">
                    <i class="ri-history-line text-primary"></i>
                    Recent Activity
                </h2>
                <div class="space-y-4">
                    {% for record in attendance_records %}
                    <div class="flex items-start gap-3">
                        <div class="avatar placeholder">
                            <div class="w-8 h-8 rounded-lg bg-primary text-primary-content">
                                <span>{{ record.name[0].upper() }}</span>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium">{{ record.name }}</p>
                            <p class="text-sm opacity-60">{{ record.subject_name }}</p>
                            <p class="text-xs opacity-50">{{ record.timestamp }}</p>
                        </div>
                        <div class="badge badge-{{ record.status|lower }}">
                            {{ record.status }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recognition Progress Modal -->
<dialog id="recognitionModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Face Recognition Progress</h3>
        <div class="space-y-4">
            <progress class="progress progress-primary w-full" value="0" max="100" id="recognitionProgressBar"></progress>
            <p id="recognitionMessage" class="text-center">Initializing...</p>
        </div>
    </div>
</dialog>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Get attendance data from server-side
const chartData = JSON.parse('{{ attendance_data | tojson | safe }}');

// Initialize attendance chart
const ctx = document.getElementById('attendanceChart').getContext('2d');
const attendanceChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: chartData.labels,
        datasets: [{
            label: 'Attendance %',
            data: chartData.values,
            borderColor: 'rgb(var(--p))',
            backgroundColor: 'rgb(var(--p) / 0.1)',
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        }
    }
});

// Recognition progress handling
let recognitionProgress = 0;
const recognitionModal = document.getElementById('recognitionModal');
const progressBar = document.getElementById('recognitionProgressBar');
const messageEl = document.getElementById('recognitionMessage');
const statusEl = document.getElementById('recognitionStatus');
const progressTextEl = document.getElementById('recognitionProgress');

function updateRecognitionProgress(progress, message) {
    recognitionProgress = progress;
    progressBar.value = progress;
    messageEl.textContent = message;
    progressTextEl.textContent = `${progress}% Complete`;
    
    if (progress === 100) {
        statusEl.textContent = 'Complete';
        setTimeout(() => {
            recognitionModal.close();
            statusEl.textContent = 'Ready';
            progressTextEl.textContent = '';
        }, 1000);
    } else {
        statusEl.textContent = 'Processing';
    }
}

// Example of how to use the progress update
// This should be called from your face recognition code
window.showRecognitionProgress = function() {
    recognitionModal.showModal();
    recognitionProgress = 0;
    updateRecognitionProgress(0, 'Starting face recognition...');
    
    // Simulate progress (replace with actual recognition progress)
    const interval = setInterval(() => {
        if (recognitionProgress < 100) {
            recognitionProgress += 10;
            updateRecognitionProgress(
                recognitionProgress,
                recognitionProgress < 50 ? 'Detecting faces...' :
                recognitionProgress < 80 ? 'Matching faces...' :
                'Finalizing results...'
            );
        } else {
            clearInterval(interval);
        }
    }, 500);
};
</script>
{% endblock %} 
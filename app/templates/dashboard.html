{% extends "base.html" %}

{% block title %}Dashboard - AttendanceAI{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Total Students -->
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-primary">
                    <i class="ri-user-line text-3xl"></i>
                </div>
                <div class="stat-title">Total Students</div>
                <div class="stat-value text-primary">{{ stats.total_students }}</div>
            </div>
        </div>
        
        <!-- Total Subjects -->
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-secondary">
                    <i class="ri-book-line text-3xl"></i>
                </div>
                <div class="stat-title">Total Subjects</div>
                <div class="stat-value text-secondary">{{ stats.total_subjects }}</div>
            </div>
        </div>
        
        <!-- Today's Attendance -->
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-accent">
                    <i class="ri-calendar-check-line text-3xl"></i>
                </div>
                <div class="stat-title">Today's Attendance</div>
                <div class="stat-value text-accent">{{ stats.today_attendance }}%</div>
                <div class="stat-desc">{{ stats.attendance_trend }}</div>
            </div>
        </div>
        
        <!-- Recognition Status -->
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-success">
                    <i class="ri-face-recognition-line text-3xl"></i>
                </div>
                <div class="stat-title">Recognition Status</div>
                <div class="stat-value text-success" id="recognitionStatus">Ready</div>
                <div class="stat-desc" id="recognitionProgress"></div>
            </div>
        </div>
    </div>
    
    <!-- Face Recognition Section -->
    <div class="card bg-base-100 shadow-lg">
        <div class="card-body p-4">
            <!-- Title -->
            <h2 class="card-title flex items-center gap-2 mb-4">
                <i class="ri-face-recognition-line text-primary"></i>
                Take Attendance
                <span class="badge badge-sm">Face Recognition</span>
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-[1fr_250px] gap-4 max-w-4xl mx-auto">
                <!-- Camera Section -->
                <div class="relative bg-base-200 aspect-[4/3] max-h-[320px] rounded-lg overflow-hidden">
                    <!-- Image Preview -->
                    <div id="imagePreview" class="w-full h-full">
                        <img id="previewImage" class="w-full h-full object-cover">
                        <button onclick="clearImagePreview()" class="btn btn-circle btn-sm absolute top-2 right-2">
                            <i class="ri-close-line"></i>
                        </button>
                    </div>
                    
                    <!-- Camera Feed (Hidden by default) -->
                    <video id="video" class="w-full h-full object-cover hidden" autoplay playsinline></video>
                    <canvas id="canvas" class="hidden"></canvas>
                    
                    <!-- Logo Overlay -->
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-3xl font-bold text-white/10 uppercase tracking-widest pointer-events-none">AttendanceAI</div>
                    
                    <!-- Face Detection Overlay -->
                    <div id="faceOverlay" class="absolute inset-0 pointer-events-none"></div>
                    
                    <!-- Status Message -->
                    <div class="absolute bottom-2 left-2 right-2">
                        <div id="status" class="alert alert-info bg-black/50 text-white border border-white/10 shadow-lg py-1 px-3 backdrop-blur-sm text-sm">
                            <i class="ri-information-line"></i>
                            <span>Upload an image or use camera to detect faces</span>
                        </div>
                    </div>
                </div>
                
                <!-- Controls Section -->
                <div class="bg-base-100 flex flex-col items-center gap-3 p-3">
                    <!-- Stats -->
                    <div class="stats bg-base-200 shadow w-full">
                        <div class="stat py-2 px-4">
                            <div class="stat-title text-xs font-medium opacity-60 uppercase tracking-wider">Faces</div>
                            <div class="stat-value text-xl font-semibold tracking-tight" id="faceCounter">0</div>
                        </div>
                    </div>
                    
                    <!-- Upload Controls -->
                    <div class="space-y-2 w-full">
                        <label class="btn btn-sm btn-outline gap-2 w-full">
                            <i class="ri-image-add-line"></i>
                            Upload Image
                            <input type="file" id="imageUpload" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                        </label>
                        
                        <div class="divider text-xs opacity-50 my-1">OR</div>
                        
                        <!-- Camera Controls -->
                        <div class="flex justify-center gap-2">
                            <button onclick="startCamera()" class="btn btn-sm btn-circle btn-outline" title="Start Camera">
                                <i class="ri-camera-line"></i>
                            </button>
                            <button onclick="stopCamera()" class="btn btn-sm btn-circle btn-outline" title="Stop Camera">
                                <i class="ri-camera-off-line"></i>
                            </button>
                            <button id="switchCamera" class="btn btn-sm btn-circle btn-outline" title="Switch Camera">
                                <i class="ri-camera-switch-line"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Confirm Button -->
                    <button onclick="showConfirmationModal()" id="confirmBtn" class="btn btn-success btn-sm gap-2 opacity-50 pointer-events-none w-full" disabled>
                        <i class="ri-check-double-line"></i>
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Attendance Chart -->
        <div class="card bg-base-100 shadow-lg lg:col-span-2">
            <div class="card-body">
                <h2 class="card-title flex items-center gap-2">
                    <i class="ri-line-chart-line text-primary"></i>
                    Attendance Trend
                </h2>
                <div class="h-[300px]">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title flex items-center gap-2">
                    <i class="ri-history-line text-primary"></i>
                    Recent Activity
                </h2>
                <div class="space-y-4">
                    {% for record in attendance_records %}
                    <div class="flex items-start gap-3">
                        <div class="avatar placeholder">
                            <div class="w-8 h-8 rounded-lg bg-primary text-primary-content">
                                <span>{{ record.name[0].upper() if record.name else 'U' }}</span>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium">{{ record.name or 'Unknown' }}</p>
                            <p class="text-sm opacity-60">{{ record.subject_name }}</p>
                        </div>
                        <div class="badge badge-{{ 'success' if record.status == 'PRESENT' else 'error' }}">
                            {{ record.status }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recognition Progress Modal -->
<dialog id="recognitionModal" class="modal">
    <div class="modal-box max-w-sm">
        <h3 class="font-bold text-lg mb-4">Processing...</h3>
        <div class="space-y-4">
            <div class="flex items-center gap-4">
                <div class="loading loading-spinner loading-md"></div>
                <div class="flex-1">
                    <div class="w-full bg-base-200 rounded-full h-2">
                        <div class="bg-primary h-2 rounded-full transition-all duration-300" id="recognitionProgressBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <p id="recognitionMessage" class="text-sm text-center">Initializing...</p>
        </div>
    </div>
</dialog>

<!-- Recognition Success Modal -->
<dialog id="recognitionSuccessModal" class="modal">
    <div class="modal-box max-w-sm">
        <h3 class="font-bold text-lg mb-4">Detected Students</h3>
        <div id="recognitionSuccessMessage" class="space-y-2 mb-4"></div>
        <div class="modal-action">
            <form method="dialog" class="flex gap-2">
                <button class="btn btn-sm">Cancel</button>
                <button onclick="confirmAllAttendance()" class="btn btn-sm btn-primary gap-2">
                    <i class="ri-check-double-line"></i>
                    Mark Present
                </button>
            </form>
        </div>
    </div>
</dialog>

<!-- Camera Access Modal -->
<dialog id="cameraModal" class="modal">
    <div class="modal-box max-w-sm">
        <h3 class="font-bold text-lg mb-4">Camera Access Required</h3>
        <p class="text-sm">Please allow camera access to use face recognition features.</p>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn btn-sm">Close</button>
            </form>
        </div>
    </div>
</dialog>

<!-- Confirmation Modal -->
<dialog id="confirmationModal" class="modal">
    <div class="modal-box max-w-sm">
        <h3 class="font-bold text-lg mb-4">Confirm Attendance</h3>
        <div id="studentsList" class="space-y-3 max-h-96 overflow-y-auto mb-4">
            <!-- Student details will be inserted here -->
        </div>
        <div class="modal-action">
            <button onclick="closeConfirmationModal()" class="btn btn-sm">Cancel</button>
            <button onclick="confirmAttendance()" class="btn btn-success btn-sm">Confirm</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
let width = 1280;
let height = 0;
let streaming = false;
let video = null;
let canvas = null;
let switchCameraButton = null;
let confirmButton = null;
let stream = null;
let detectedStudents = new Map();
let processingFrame = false;
let lastProcessedTime = 0;
const PROCESS_INTERVAL = 1000; // Process every 1 second
let animationFrameId = null;

function showMessage(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} fixed bottom-4 right-4 w-auto max-w-sm z-50 animate-fade-in`;
    toast.innerHTML = `
        <i class="ri-${type === 'success' ? 'checkbox-circle' : type === 'error' ? 'error-warning' : 'information'}-line"></i>
        <span>${message}</span>
    `;
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.classList.add('opacity-0');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function updateStatus(message, type = 'info') {
    const status = document.getElementById('status');
    status.className = `alert bg-black/50 text-white border-${type} shadow-lg py-2 backdrop-blur-sm animate-fade-in`;
    status.innerHTML = `<i class="ri-information-line"></i><span>${message}</span>`;
}

function drawFaceBox(face) {
    const overlay = document.getElementById('faceOverlay');
    const box = document.createElement('div');
    
    // Get the actual displayed dimensions of the video
    const videoRect = video.getBoundingClientRect();
    const scaleX = videoRect.width / width;
    const scaleY = videoRect.height / height;
    
    // Scale the bounding box coordinates
    const scaledX = face.boundingBox.x * scaleX;
    const scaledY = face.boundingBox.y * scaleY;
    const scaledW = face.boundingBox.width * scaleX;
    const scaledH = face.boundingBox.height * scaleY;
    
    // Change border color based on match status
    const borderColor = face.match ? (face.match.alreadyMarked ? 'border-warning' : 'border-success') : 'border-error';
    box.className = `absolute border-2 ${borderColor} rounded-lg transition-all duration-200 shadow-lg animate-fade-in`;
    box.style.left = `${scaledX}px`;
    box.style.top = `${scaledY}px`;
    box.style.width = `${scaledW}px`;
    box.style.height = `${scaledH}px`;
    
    if (face.match) {
        // Name label with attendance status
        const label = document.createElement('div');
        const bgColor = face.match.alreadyMarked ? 'bg-warning' : 'bg-success';
        label.className = `absolute -top-6 left-0 right-0 text-center ${bgColor} text-${bgColor}-content px-2 py-0.5 rounded-t-lg text-xs font-medium shadow-lg`;
        label.textContent = face.match.name + (face.match.alreadyMarked ? ' (Marked)' : '');
        box.appendChild(label);
        
        // Confidence label
        const confidence = document.createElement('div');
        confidence.className = 'absolute -bottom-6 left-0 right-0 text-center bg-black/50 backdrop-blur-sm text-white text-xs py-0.5 shadow-lg';
        confidence.textContent = `${Math.round(face.match.confidence)}%`;
        box.appendChild(confidence);
    }
    
    overlay.appendChild(box);
}

function clearFaceBoxes() {
    const overlay = document.getElementById('faceOverlay');
    while (overlay.firstChild) {
        overlay.removeChild(overlay.firstChild);
    }
    overlay.innerHTML = '';
}

function updateDetectedFaces(faces) {
    const count = document.getElementById('faceCounter');
    const confirmBtn = document.getElementById('confirmBtn');
    
    // Clear previous faces
    detectedStudents.clear();
    
    faces.forEach(face => {
        if (face.match) {
            // Store only the highest confidence match for each student
            const existingMatch = detectedStudents.get(face.match.student_id);
            if (!existingMatch || face.match.confidence > existingMatch.confidence) {
                detectedStudents.set(face.match.student_id, face.match);
            }
        }
        // Draw face box
        drawFaceBox(face);
    });
    
    // Update counter and confirm button state
    const uniqueFaces = detectedStudents.size;
    count.textContent = uniqueFaces;
    
    if (uniqueFaces > 0) {
        confirmBtn.classList.remove('opacity-50', 'pointer-events-none');
        confirmBtn.disabled = false;
        updateStatus(`${uniqueFaces} student${uniqueFaces > 1 ? 's' : ''} detected`, 'success');
    } else {
        confirmBtn.classList.add('opacity-50', 'pointer-events-none');
        confirmBtn.disabled = true;
        updateStatus('Position students to detect faces');
    }
}

async function startup() {
    video = document.getElementById('video');
    canvas = document.getElementById('canvas');
    switchCameraButton = document.getElementById('switchCamera');
    confirmButton = document.getElementById('confirmBtn');
    
    try {
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: 'user'
            }, 
            audio: false 
        })
        .then(function(str) {
            stream = str;
            video.srcObject = stream;
            
            // Hide preview, show video
            document.getElementById('imagePreview').classList.add('hidden');
            video.classList.remove('hidden');
            
            video.play();
            
            video.addEventListener('canplay', function() {
                if (!streaming) {
                    height = video.videoHeight / (video.videoWidth / width);
                    video.setAttribute('width', width);
                    video.setAttribute('height', height);
                    canvas.setAttribute('width', width);
                    canvas.setAttribute('height', height);
                    streaming = true;
                    
                    // Start face detection
                    detectFaces();
                }
            }, false);
            
            showMessage('Camera started successfully', 'success');
        })
        .catch(function(err) {
            showMessage('Failed to access camera: ' + err.message, 'error');
            document.getElementById('cameraModal').showModal();
        });
    } catch (err) {
        showMessage('Failed to access camera: ' + err.message, 'error');
        document.getElementById('cameraModal').showModal();
    }
}

function stopCamera() {
    if (stream) {
        // Stop all tracks
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        streaming = false;
        
        // Cancel animation frame if it exists
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
        
        // Clear all detection elements
        clearFaceBoxes();
        detectedStudents.clear();
        document.getElementById('faceCounter').textContent = '0';
        
        // Reset UI elements
        const confirmBtn = document.getElementById('confirmBtn');
        confirmBtn.classList.add('opacity-50', 'pointer-events-none');
        confirmBtn.disabled = true;
        
        // Reset status message
        updateStatus('Camera stopped', 'info');
        showMessage('Camera stopped', 'info');
        
        // Reset video element and canvas
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Clear face overlay and ensure it's empty
        const overlay = document.getElementById('faceOverlay');
        while (overlay.firstChild) {
            overlay.removeChild(overlay.firstChild);
        }
        overlay.innerHTML = '';
        
        // Force a reflow to ensure all elements are cleared
        video.style.display = 'none';
        void video.offsetHeight; // Force reflow
        video.style.display = 'block';
    }
}

async function switchCamera() {
    if (stream) {
        // Stop current stream
        stream.getTracks().forEach(track => track.stop());
        
        // Get current facing mode
        const currentFacingMode = stream.getVideoTracks()[0].getSettings().facingMode;
        const newFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
        
        try {
            // Start new stream with opposite facing mode
            stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: newFacingMode
                },
                audio: false
            });
            video.srcObject = stream;
            showMessage('Camera switched', 'success');
        } catch (err) {
            showMessage('Failed to switch camera: ' + err.message, 'error');
        }
    }
}

async function detectFaces() {
    if (!streaming) {
        // Stop the detection loop if streaming is false
        clearFaceBoxes();
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
        return;
    }
    
    if (processingFrame || Date.now() - lastProcessedTime < PROCESS_INTERVAL) {
        animationFrameId = requestAnimationFrame(detectFaces);
        return;
    }
    
    processingFrame = true;
    lastProcessedTime = Date.now();
    
    try {
        // Capture frame
        canvas.getContext('2d').drawImage(video, 0, 0, width, height);
        const imageData = canvas.toDataURL('image/jpeg', 0.8);
        
        // Send to server for face detection
        const response = await fetch('/detect_faces', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({ image: imageData })
        });
        
        if (response.ok) {
            const result = await response.json();
            clearFaceBoxes();
            updateDetectedFaces(result.faces);
        }
    } catch (err) {
        console.error('Face detection error:', err);
        updateStatus('Face detection error: ' + err.message, 'error');
    }
    
    processingFrame = false;
    if (streaming) {
        animationFrameId = requestAnimationFrame(detectFaces);
    }
}

function showConfirmationModal() {
    const modal = document.getElementById('confirmationModal');
    const studentsList = document.getElementById('studentsList');
    studentsList.innerHTML = '';
    
    detectedStudents.forEach(student => {
        const item = document.createElement('div');
        item.className = 'flex items-center justify-between p-2 bg-base-200 rounded-lg';
        item.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="avatar placeholder">
                    <div class="w-8 h-8 rounded-lg bg-primary text-primary-content">
                        <span>${student.name[0].toUpperCase()}</span>
                    </div>
                </div>
                <div>
                    <p class="font-medium">${student.name}</p>
                    <p class="text-sm opacity-60">${student.student_id}</p>
                </div>
            </div>
            <div class="badge ${student.alreadyMarked ? 'badge-warning' : 'badge-success'}">
                ${student.alreadyMarked ? 'Already Marked' : 'Present'}
            </div>
        `;
        studentsList.appendChild(item);
    });
    
    modal.showModal();
}

function closeConfirmationModal() {
    document.getElementById('confirmationModal').close();
}

async function confirmAttendance() {
    const studentIds = Array.from(detectedStudents.keys());
    
    try {
        const response = await fetch('/mark_classroom_attendance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({ 
                students: Array.from(detectedStudents.values())
            })
        });
        
        if (response.ok) {
            showMessage('Attendance marked successfully', 'success');
            closeConfirmationModal();
            // Clear everything
            clearImagePreview();
            if (streaming) {
                stopCamera();
            }
        } else {
            throw new Error('Failed to mark attendance');
        }
    } catch (err) {
        showMessage('Failed to mark attendance: ' + err.message, 'error');
    }
}

// Add these new functions for image upload handling
async function handleImageUpload(event) {
    const file = event.target.files[0];
    if (file) {
        // Stop camera if it's running
        if (streaming) {
            stopCamera();
        }
        
        // Show preview
        const preview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImage');
        const video = document.getElementById('video');
        
        // Hide video, show preview
        video.classList.add('hidden');
        preview.classList.remove('hidden');
        
        // Read and process image
        const reader = new FileReader();
        reader.onload = async function(e) {
            previewImg.src = e.target.result;
            
            try {
                // Send to server for face detection
                const response = await fetch('/detect_faces', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({ image: e.target.result })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    clearFaceBoxes();
                    updateDetectedFaces(result.faces);
                }
            } catch (err) {
                console.error('Face detection error:', err);
                updateStatus('Face detection error: ' + err.message, 'error');
            }
        };
        reader.readAsDataURL(file);
    }
}

function clearImagePreview() {
    const preview = document.getElementById('imagePreview');
    const input = document.getElementById('imageUpload');
    const video = document.getElementById('video');
    
    preview.classList.add('hidden');
    input.value = '';
    clearFaceBoxes();
    detectedStudents.clear();
    document.getElementById('faceCounter').textContent = '0';
    updateStatus('Upload an image or use camera to detect faces', 'info');
    
    // Reset confirm button
    const confirmBtn = document.getElementById('confirmBtn');
    confirmBtn.classList.add('opacity-50', 'pointer-events-none');
    confirmBtn.disabled = true;
}

// Start camera when page loads
document.addEventListener('DOMContentLoaded', startup);

// Add event listeners
document.getElementById('switchCamera').addEventListener('click', switchCamera);

// Add resize handler to update boxes when video size changes
window.addEventListener('resize', () => {
    if (streaming) {
        clearFaceBoxes();
        const lastFaces = Array.from(detectedStudents.values()).map(student => ({
            boundingBox: student.boundingBox,
            match: student
        }));
        lastFaces.forEach(drawFaceBox);
    }
});

// Initialize attendance chart
document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById('attendanceChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    const labels = {{ dates|tojson|safe }};
    const presentData = {{ present_counts|tojson|safe }};
    const absentData = {{ absent_counts|tojson|safe }};

    const config = {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Present',
                data: presentData,
                borderColor: '#36D399',
                backgroundColor: '#36D39920',
                tension: 0.4,
                fill: true
            }, {
                label: 'Absent',
                data: absentData,
                borderColor: '#F87272',
                backgroundColor: '#F8727220',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const label = context.dataset.label || '';
                            return label ? `${label}: ${context.parsed.y} students` : '';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    };

    new Chart(ctx, config);
});
</script>
{% endblock %} 
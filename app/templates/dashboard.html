{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Dashboard</h1>
    
    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- Face Recognition Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Face Recognition</h2>
            
            {% if current_user.role in ['admin', 'teacher'] %}
            <!-- Register Face Form -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h3 class="text-lg font-medium text-gray-900 mb-3">Register New Face</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="reg_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Student ID</label>
                        <input type="text" id="reg_student_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Image</label>
                        <input type="file" id="reg_image" accept="image/*" onchange="previewImage(this, 'reg_preview')" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <img id="reg_preview" class="mt-2 max-h-48 hidden">
                    </div>
                    <button onclick="registerFace()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors">
                        Register Face
                    </button>
                </div>
                <div id="register_result" class="mt-3 hidden"></div>
            </div>
            {% endif %}
            
            <!-- Recognize Face Form -->
            <div class="p-4 bg-gray-50 rounded-lg">
                <h3 class="text-lg font-medium text-gray-900 mb-3">Recognize Face</h3>
                <div class="space-y-4">
                    {% if current_user.role != 'student' %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Subject</label>
                        <select id="rec_subject_select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="">-- Select Subject --</option>
                            {% for subject in subjects %}
                            <option value="{{ subject.id }}">{{ subject.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Image</label>
                        <input type="file" id="rec_image" accept="image/*" onchange="previewImage(this, 'rec_preview')" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                        <img id="rec_preview" class="mt-2 max-h-48 hidden">
                    </div>
                    <button onclick="recognizeFace()" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                        Recognize Face
                    </button>
                </div>
                <div id="recognize_result" class="mt-3 hidden"></div>
            </div>
        </div>
        
        <!-- Recent Activity Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Recent Activity</h2>
            <div class="space-y-4">
                {% if attendance_records %}
                {% for record in attendance_records %}
                <div class="p-3 bg-gray-50 rounded-md">
                    <p class="text-sm text-gray-600">{{ record.timestamp }}</p>
                    <p class="font-medium">{{ record.name }}</p>
                    <p class="text-sm text-gray-500">{{ record.subject_name }}</p>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-gray-500">No recent activity</p>
                {% endif %}
            </div>
        </div>
        
    </div>
</div>

<!-- JavaScript for Face Recognition -->
<script>
function previewImage(input, previewId) {
    const preview = document.getElementById(previewId);
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
        }
        reader.readAsDataURL(file);
    }
}

function showResult(element, message, type = 'success') {
    element.textContent = message;
    element.classList.remove('hidden');
    element.className = `mt-3 p-3 rounded-md ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
}

async function getBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

async function registerFace() {
    const name = document.getElementById('reg_name').value.trim();
    const studentId = document.getElementById('reg_student_id').value.trim();
    const file = document.getElementById('reg_image').files[0];
    const resultDiv = document.getElementById('register_result');
    
    if (!name || !studentId || !file) {
        showResult(resultDiv, 'Please fill in all fields', 'error');
        return;
    }
    
    try {
        const base64Image = await getBase64(file);
        const response = await fetch('/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                student_id: studentId,
                image: base64Image
            })
        });
        
        const data = await response.json();
        showResult(resultDiv, data.message || data.error, response.ok ? 'success' : 'error');
    } catch (error) {
        showResult(resultDiv, 'An error occurred while registering the face', 'error');
    }
}

async function recognizeFace() {
    const file = document.getElementById('rec_image').files[0];
    const subjectSelect = document.getElementById('rec_subject_select');
    const subjectId = subjectSelect ? subjectSelect.value : '';
    const resultDiv = document.getElementById('recognize_result');
    
    if (!file) {
        showResult(resultDiv, 'Please select an image', 'error');
        return;
    }
    
    try {
        const base64Image = await getBase64(file);
        const response = await fetch('/recognize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image: base64Image,
                subject_id: subjectId
            })
        });
        
        const data = await response.json();
        let resultMessage = data.message + '\n\n';
        if (data.identified_people) {
            resultMessage += 'Identified People:\n';
            data.identified_people.forEach(person => {
                if (person.name && person.student_id) {
                    resultMessage += `- ${person.name} (ID: ${person.student_id}) Confidence: ${person.confidence}%\n`;
                } else {
                    resultMessage += `- ${person.message}\n`;
                }
            });
        }
        
        showResult(resultDiv, resultMessage, response.ok ? 'success' : 'error');
    } catch (error) {
        showResult(resultDiv, 'An error occurred while recognizing faces', 'error');
    }
}
</script>
{% endblock %} 
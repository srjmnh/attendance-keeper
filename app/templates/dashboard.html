{% extends "base.html" %}

{% block title %}Dashboard - AttendanceAI{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Total Students -->
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-primary">
                    <i class="ri-user-line text-3xl"></i>
                </div>
                <div class="stat-title">Total Students</div>
                <div class="stat-value text-primary">{{ total_students }}</div>
            </div>
        </div>
        
        <!-- Total Subjects -->
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-secondary">
                    <i class="ri-book-line text-3xl"></i>
                </div>
                <div class="stat-title">Total Subjects</div>
                <div class="stat-value text-secondary">{{ total_subjects }}</div>
            </div>
        </div>
        
        <!-- Today's Attendance -->
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-accent">
                    <i class="ri-calendar-check-line text-3xl"></i>
                </div>
                <div class="stat-title">Today's Attendance</div>
                <div class="stat-value text-accent">{{ today_attendance }}%</div>
                <div class="stat-desc">{{ attendance_trend }}</div>
            </div>
        </div>
        
        <!-- Recognition Status -->
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-success">
                    <i class="ri-face-recognition-line text-3xl"></i>
                </div>
                <div class="stat-title">Recognition Status</div>
                <div class="stat-value text-success" id="recognitionStatus">Ready</div>
                <div class="stat-desc" id="recognitionProgress"></div>
            </div>
        </div>
    </div>
    
    <!-- Recognition Controls -->
    {% if current_user.role in ['admin', 'teacher'] %}
    <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
            <h2 class="card-title flex items-center gap-2">
                <i class="ri-camera-line text-primary"></i>
                Face Recognition & Registration
            </h2>
            
            <!-- Mode Selection -->
            <div class="tabs tabs-boxed">
                <a class="tab tab-active" onclick="switchMode('recognition')" id="recognitionTab">Take Attendance</a>
                <a class="tab" onclick="switchMode('registration')" id="registrationTab">Register Face</a>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Camera Section -->
                <div class="space-y-4">
                    <!-- Camera Preview -->
                    <div class="relative bg-base-200 rounded-lg overflow-hidden" style="height: 240px;">
                        <video id="cameraPreview" class="w-full h-full object-cover" autoplay playsinline></video>
                        <canvas id="photoCanvas" class="hidden"></canvas>
                    </div>
                    
                    <!-- Camera Controls -->
                    <div class="flex gap-2">
                        <button onclick="startCamera()" class="btn btn-outline btn-sm gap-2">
                            <i class="ri-camera-line"></i>
                            Start Camera
                        </button>
                        <button onclick="stopCamera()" class="btn btn-outline btn-sm gap-2">
                            <i class="ri-camera-off-line"></i>
                            Stop Camera
                        </button>
                    </div>
                </div>
                
                <!-- Controls Section -->
                <div class="space-y-4">
                    <!-- Subject Selection -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Subject</span>
                        </label>
                        <select id="subjectSelect" class="select select-bordered w-full">
                            <option value="">Select Subject</option>
                        </select>
                    </div>
                    
                    <!-- Camera Controls -->
                    <div class="flex flex-col gap-2 mt-4">
                        <button onclick="captureAndRecognize()" class="btn btn-primary btn-sm gap-2">
                            <i class="ri-camera-lens-line"></i>
                            Take Attendance
                        </button>
                        <div class="divider">OR</div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Upload Image</span>
                            </label>
                            <input type="file" id="recognitionFile" accept="image/*" class="file-input file-input-bordered file-input-sm w-full" onchange="handleRecognitionUpload()" />
                        </div>
                    </div>
                    
                    <!-- Registration Mode -->
                    <div id="registrationControls" class="hidden">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Student Details</span>
                            </label>
                            <input type="text" id="studentName" placeholder="Student Name" class="input input-bordered input-sm mb-2" />
                            <input type="text" id="studentId" placeholder="Student ID" class="input input-bordered input-sm mb-2" />
                            
                            {% if current_user.role == 'admin' %}
                            <!-- Admin sees all classes -->
                            <select id="studentClass" class="select select-bordered select-sm mb-2">
                                <option value="">Select Class</option>
                                {% for class in range(1, 13) %}
                                    <option value="{{ class }}">Class {{ class }}</option>
                                {% endfor %}
                            </select>
                            <select id="studentDivision" class="select select-bordered select-sm">
                                <option value="">Select Division</option>
                                {% for div in ['A', 'B', 'C', 'D'] %}
                                    <option value="{{ div }}">Division {{ div }}</option>
                                {% endfor %}
                            </select>
                            {% else %}
                            <!-- Teachers see assigned classes as modern chips -->
                            <div class="mb-2">
                                <label class="label">
                                    <span class="label-text">Select Class & Division</span>
                                </label>
                                <div class="flex flex-wrap gap-2" id="classChipsContainer">
                                    {% for class_id in current_user.classes|sort %}
                                    {% set class_parts = class_id.split('-') %}
                                    <button type="button" 
                                            onclick="selectClass('{{ class_id }}', '{{ class_parts[0] }}', '{{ class_parts[1] }}')"
                                            class="class-chip px-3 py-2 rounded-lg bg-base-200 hover:bg-base-300 transition-colors"
                                            data-class-id="{{ class_id }}">
                                        Class {{ class_parts[0] }}-{{ class_parts[1] }}
                                    </button>
                                    {% endfor %}
                                </div>
                                <input type="hidden" id="studentClass">
                                <input type="hidden" id="studentDivision">
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="flex flex-col gap-2 mt-4">
                            <button onclick="captureAndRegister()" class="btn btn-primary btn-sm gap-2">
                                <i class="ri-user-add-line"></i>
                                Register Face
                            </button>
                            <div class="divider">OR</div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Upload Image</span>
                                </label>
                                <input type="file" id="registrationFile" accept="image/*" class="file-input file-input-bordered file-input-sm w-full" onchange="handleRegistrationUpload()" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Attendance Chart -->
        <div class="card bg-base-100 shadow-lg lg:col-span-2">
            <div class="card-body">
                <h2 class="card-title flex items-center gap-2">
                    <i class="ri-line-chart-line text-primary"></i>
                    Attendance Trend
                </h2>
                <div class="h-[300px]">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title flex items-center gap-2">
                    <i class="ri-history-line text-primary"></i>
                    Recent Activity
                </h2>
                <div class="space-y-4">
                    {% for record in attendance_records %}
                    <div class="flex items-start gap-3">
                        <div class="avatar placeholder">
                            <div class="w-8 h-8 rounded-lg bg-primary text-primary-content">
                                <span>{{ record.name[0].upper() }}</span>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium">{{ record.name }}</p>
                            <p class="text-sm opacity-60">{{ record.subject_name }}</p>
                            <p class="text-xs opacity-50">{{ record.timestamp }}</p>
                        </div>
                        <div class="badge badge-{{ record.status|lower }}">
                            {{ record.status }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recognition Progress Modal -->
<dialog id="recognitionModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Face Recognition Progress</h3>
        <div class="space-y-4">
            <progress class="progress progress-primary w-full" value="0" max="100" id="recognitionProgressBar"></progress>
            <p id="recognitionMessage" class="text-center">Initializing...</p>
        </div>
    </div>
</dialog>

<!-- Camera Access Modal -->
<dialog id="cameraModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Camera Access Required</h3>
        <p>Please allow camera access to use face recognition features.</p>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn">Close</button>
            </form>
        </div>
    </div>
</dialog>

<!-- Recognition Success Modal -->
<dialog id="recognitionSuccessModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Recognition Results</h3>
        <div id="recognitionSuccessMessage" class="prose"></div>
        <div class="modal-action">
            <button class="btn btn-primary" onclick="document.getElementById('recognitionSuccessModal').close()">OK</button>
        </div>
    </div>
</dialog>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Get attendance data from server-side
const chartData = JSON.parse('{{ attendance_data | tojson | safe }}');

// Initialize attendance chart
const ctx = document.getElementById('attendanceChart').getContext('2d');
const attendanceChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: chartData.labels,
        datasets: [{
            label: 'Attendance %',
            data: chartData.values,
            borderColor: 'rgb(var(--p))',
            backgroundColor: 'rgb(var(--p) / 0.1)',
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        }
    }
});

// Camera handling
let stream = null;
const video = document.getElementById('cameraPreview');
const canvas = document.getElementById('photoCanvas');

async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'user',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        });
        video.srcObject = stream;
    } catch (error) {
        console.error('Camera error:', error);
        document.getElementById('cameraModal').showModal();
    }
}

function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        stream = null;
    }
}

async function captureAndRecognize() {
    const subjectSelect = document.getElementById('subjectSelect');
    const subjectId = subjectSelect.value;
    const subjectName = subjectSelect.selectedOptions[0]?.dataset?.name;
    
    if (!subjectId) {
        alert('Please select a subject first');
        return;
    }
    
    if (!stream) {
        alert('Please start the camera first');
        return;
    }
    
    try {
        // Capture photo
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        // Convert to base64
        const imageData = canvas.toDataURL('image/jpeg', 0.9);
        await recognizeFaces(imageData, subjectId, subjectName);
    } catch (error) {
        console.error('Recognition failed:', error);
        showToast(error.message, 'error');
    }
}

// Recognition progress handling
let recognitionProgress = 0;
const recognitionModal = document.getElementById('recognitionModal');
const progressBar = document.getElementById('recognitionProgressBar');
const messageEl = document.getElementById('recognitionMessage');
const statusEl = document.getElementById('recognitionStatus');
const progressTextEl = document.getElementById('recognitionProgress');

function updateRecognitionProgress(progress, message) {
    recognitionProgress = progress;
    progressBar.value = progress;
    messageEl.textContent = message;
    progressTextEl.textContent = `${progress}% Complete`;
    
    if (progress === 100) {
        statusEl.textContent = 'Complete';
        setTimeout(() => {
            recognitionModal.close();
            statusEl.textContent = 'Ready';
            progressTextEl.textContent = '';
        }, 1000);
    } else {
        statusEl.textContent = 'Processing';
    }
}

// Function to handle face registration
async function registerFace(imageData, name, studentId, studentClass, division) {
    const messageEl = document.getElementById('recognition_message');
    const progressBar = document.getElementById('recognition_progress');
    const statusEl = document.getElementById('recognition_status');
    
    try {
        recognitionModal.showModal();
        updateRecognitionProgress(0, 'Starting registration...');
        
        const response = await fetch('/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                student_id: studentId,
                class: studentClass,
                division: division,
                image: imageData
            })
        });
        
        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error || 'Registration failed');
        }
        
        updateRecognitionProgress(100, data.message || 'Registration successful!');
        
        // Clear form
        document.getElementById('studentName').value = '';
        document.getElementById('studentId').value = '';
        document.getElementById('studentClass').value = '';
        document.getElementById('studentDivision').value = '';
        if (document.getElementById('registrationFile')) {
            document.getElementById('registrationFile').value = '';
        }
        
        showToast(data.message, 'success');
        setTimeout(() => {
            recognitionModal.close();
        }, 2000);
        
        return data;
    } catch (error) {
        console.error('Registration error:', error);
        messageEl.textContent = error.message;
        progressBar.value = 0;
        statusEl.textContent = 'Error';
        showToast(error.message, 'error');
        throw error;
    }
}

// Function to handle face recognition
async function recognizeFaces(imageData, subjectId, subjectName) {
    try {
        recognitionModal.showModal();
        updateRecognitionProgress(0, 'Starting face recognition...');

        // Clean base64 image data
        const base64Image = imageData.includes('base64') ? imageData : `data:image/jpeg;base64,${imageData}`;

        const response = await fetch('/recognize', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image: base64Image,
                subject_id: subjectId,
                subject_name: subjectName
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Recognition failed');
        }

        const result = await response.json();
        updateRecognitionProgress(50, 'Processing faces...');

        const totalFaces = result.total_faces;
        const identified = result.identified_people;

        updateRecognitionProgress(75, `Found ${totalFaces} face(s)...`);

        // Show results in success modal
        let message = `<div class="space-y-4">`;
        message += `<p class="text-lg font-medium">Found ${totalFaces} face(s) in the image.</p>`;
        
        if (identified.length > 0) {
            message += `<div class="space-y-2">`;
            identified.forEach(person => {
                if (person.name) {
                    message += `
                        <div class="flex items-center gap-2 p-2 bg-base-200 rounded-lg">
                            <i class="ri-user-smile-line text-success text-xl"></i>
                            <div>
                                <p class="font-medium">${person.name}</p>
                                <p class="text-sm opacity-70">Confidence: ${Math.round(person.confidence)}%</p>
                            </div>
                        </div>`;
                } else {
                    message += `
                        <div class="flex items-center gap-2 p-2 bg-base-200 rounded-lg">
                            <i class="ri-user-unfollow-line text-error text-xl"></i>
                            <p>${person.message}</p>
                        </div>`;
                }
            });
            message += `</div>`;
        }
        message += `</div>`;

        // Hide progress modal and show success modal
        recognitionModal.close();
        document.getElementById('recognitionSuccessMessage').innerHTML = message;
        document.getElementById('recognitionSuccessModal').showModal();

        // Reload page to update attendance data
        setTimeout(() => location.reload(), 3000);

        return result;
    } catch (error) {
        console.error('Recognition error:', error);
        messageEl.textContent = 'Error: ' + error.message;
        progressBar.value = 0;
        statusEl.textContent = 'Error';
        showToast(error.message, 'error');
        throw error;
    }
}

// Toast notification function
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} shadow-lg max-w-sm animate-fade-in fixed bottom-4 right-4 z-50`;
    
    const icon = document.createElement('span');
    icon.className = 'ri-information-line';
    if (type === 'success') icon.className = 'ri-checkbox-circle-line';
    else if (type === 'error') icon.className = 'ri-error-warning-line';
    else if (type === 'warning') icon.className = 'ri-alert-line';
    
    const text = document.createElement('span');
    text.textContent = message;
    
    toast.appendChild(icon);
    toast.appendChild(text);
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Mode switching
let currentMode = 'recognition';

function switchMode(mode) {
    currentMode = mode;
    document.getElementById('recognitionTab').classList.toggle('tab-active', mode === 'recognition');
    document.getElementById('registrationTab').classList.toggle('tab-active', mode === 'registration');
    document.getElementById('recognitionControls').classList.toggle('hidden', mode !== 'recognition');
    document.getElementById('registrationControls').classList.toggle('hidden', mode !== 'registration');
}

// Handle file uploads
async function handleRecognitionUpload() {
    const file = document.getElementById('recognitionFile').files[0];
    if (file) {
        const subjectSelect = document.getElementById('subjectSelect');
        const subjectId = subjectSelect.value;
        const subjectName = subjectSelect.selectedOptions[0]?.dataset?.name;
        
        if (!subjectId) {
            alert('Please select a subject first');
            return;
        }
        
        try {
            const imageData = await fileToBase64(file);
            await recognizeFaces(imageData, subjectId, subjectName);
        } catch (error) {
            console.error('Recognition failed:', error);
            showToast(error.message, 'error');
        }
    }
}

async function handleRegistrationUpload() {
    const file = document.getElementById('registrationFile').files[0];
    if (!file) {
        alert('Please select an image file');
        return;
    }

    const name = document.getElementById('studentName').value.trim();
    const studentId = document.getElementById('studentId').value.trim();
    const studentClass = document.getElementById('studentClass').value;
    const division = document.getElementById('studentDivision').value;

    if (!name || !studentId || !studentClass || !division) {
        alert('Please fill in all student details');
        return;
    }

    try {
        const imageData = await fileToBase64(file);
        await registerFace(imageData, name, studentId, studentClass, division);
    } catch (error) {
        console.error('Registration failed:', error);
        showToast(error.message, 'error');
    }
}

async function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

async function captureAndRegister() {
    const name = document.getElementById('studentName').value.trim();
    const studentId = document.getElementById('studentId').value.trim();
    const studentClass = document.getElementById('studentClass').value;
    const division = document.getElementById('studentDivision').value;
    
    if (!name || !studentId || !studentClass || !division) {
        alert('Please fill in all student details');
        return;
    }
    
    if (!stream) {
        alert('Please start the camera first');
        return;
    }
    
    try {
        // Capture photo
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0);
        
        // Convert to base64
        const imageData = canvas.toDataURL('image/jpeg', 0.9);
        await registerFace(imageData, name, studentId, studentClass, division);
    } catch (error) {
        console.error('Registration failed:', error);
        showToast(error.message, 'error');
    }
}

// Clean up camera when leaving page
window.addEventListener('beforeunload', stopCamera);

async function handleRegistration(file) {
    if (!file) {
        showToast('Please select an image', 'error');
        return;
    }

    const name = document.getElementById('studentName').value.trim();
    const studentId = document.getElementById('studentId').value.trim();
    const studentClass = document.getElementById('studentClass').value;
    const division = document.getElementById('studentDivision').value;

    // Validate all fields
    const errors = [];
    if (!name) errors.push('Name is required');
    if (!studentId) errors.push('Student ID is required');
    if (!studentClass) errors.push('Class is required');
    if (!division) errors.push('Division is required');

    // Additional validation
    if (studentClass && (isNaN(studentClass) || studentClass < 1 || studentClass > 12)) {
        errors.push('Class must be between 1 and 12');
    }
    if (division && !['A', 'B', 'C', 'D'].includes(division)) {
        errors.push('Division must be A, B, C, or D');
    }

    if (errors.length > 0) {
        showToast(errors.join('; '), 'error');
        return;
    }

    try {
        const imageData = await fileToBase64(file);
        await registerFace(imageData, name, studentId, studentClass, division);
    } catch (error) {
        console.error('Registration failed:', error);
        showToast(error.message || 'Registration failed', 'error');
    }
}

// Add event listener to the registration form
document.getElementById('registrationForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const file = document.getElementById('registrationFile').files[0];
    await handleRegistration(file);
});

function selectClass(classId, classNum, division) {
    // Remove active class from all chips
    document.querySelectorAll('.class-chip').forEach(chip => {
        chip.classList.remove('bg-primary', 'text-primary-content');
        chip.classList.add('bg-base-200');
    });
    
    // Add active class to selected chip
    const selectedChip = document.querySelector(`[data-class-id="${classId}"]`);
    if (selectedChip) {
        selectedChip.classList.remove('bg-base-200');
        selectedChip.classList.add('bg-primary', 'text-primary-content');
    }
    
    // Update hidden inputs
    document.getElementById('studentClass').value = classNum;
    document.getElementById('studentDivision').value = division;
}

// Function to load subjects
async function loadSubjects() {
    try {
        console.log('Fetching subjects...');
        const response = await fetch('/admin/api/subjects');
        const data = await response.json();
        
        if (data.error) {
            console.error('Error loading subjects:', data.error);
            showToast(data.error, 'error');
            return;
        }
        
        const subjectSelect = document.getElementById('subjectSelect');
        if (!subjectSelect) {
            console.error('Subject select element not found');
            return;
        }
        
        subjectSelect.innerHTML = '<option value="">Select Subject</option>';
        
        if (data.subjects && Array.isArray(data.subjects)) {
            // Sort subjects by class_id and then by name
            data.subjects.sort((a, b) => {
                if (a.class_id === b.class_id) {
                    return a.name.localeCompare(b.name);
                }
                return a.class_id.localeCompare(b.class_id);
            });
            
            data.subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = `${subject.name} (Class ${subject.class_id})`;
                option.dataset.classId = subject.class_id;
                subjectSelect.appendChild(option);
            });
            
            if (data.subjects.length === 0) {
                console.warn('No subjects available');
                showToast('No subjects available for your classes', 'warning');
            } else {
                console.log(`Loaded ${data.subjects.length} subjects`);
            }
        } else {
            console.error('Invalid subject data:', data);
            showToast('Invalid subject data received', 'error');
        }
    } catch (error) {
        console.error('Error loading subjects:', error);
        showToast('Failed to load subjects', 'error');
    }
}

// Load subjects when the page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing dashboard...');
    loadSubjects();
});
</script>
{% endblock %} 
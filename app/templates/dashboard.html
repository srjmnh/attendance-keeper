{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="stats shadow-lg bg-primary text-primary-content hover-scale">
            <div class="stat">
                <div class="stat-figure text-primary-content">
                    <span class="material-icons-round text-4xl">face</span>
                </div>
                <div class="stat-title text-primary-content/80">Total Students</div>
                <div class="stat-value">{{ total_students }}</div>
                <div class="stat-desc text-primary-content/60">Active in system</div>
            </div>
        </div>
        
        <div class="stats shadow-lg bg-accent text-accent-content hover-scale">
            <div class="stat">
                <div class="stat-figure text-accent-content">
                    <span class="material-icons-round text-4xl">event_available</span>
                </div>
                <div class="stat-title text-accent-content/80">Today's Attendance</div>
                <div class="stat-value">{{ today_attendance }}%</div>
                <div class="stat-desc text-accent-content/60">{{ attendance_trend }}</div>
            </div>
        </div>
        
        <div class="stats shadow-lg bg-secondary text-secondary-content hover-scale">
            <div class="stat">
                <div class="stat-figure text-secondary-content">
                    <span class="material-icons-round text-4xl">school</span>
                </div>
                <div class="stat-title text-secondary-content/80">Total Subjects</div>
                <div class="stat-value">{{ total_subjects }}</div>
                <div class="stat-desc text-secondary-content/60">Active courses</div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Face Recognition Section -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title flex items-center gap-2 mb-6">
                    <span class="material-icons-round text-primary">face</span>
                    Face Recognition
                </h2>
                
                {% if current_user.role in ['admin', 'teacher'] %}
                <!-- Register Face Form -->
                <div class="card bg-base-200 hover-scale">
                    <div class="card-body">
                        <h3 class="card-title text-lg">
                            <span class="material-icons-round text-primary">person_add</span>
                            Register New Face
                        </h3>
                        <div class="space-y-4">
                            <div class="form-control w-full">
                                <label class="label">
                                    <span class="label-text font-medium">Name</span>
                                </label>
                                <input type="text" id="reg_name" class="input input-bordered w-full" />
                            </div>
                            <div class="form-control w-full">
                                <label class="label">
                                    <span class="label-text font-medium">Student ID</span>
                                </label>
                                <input type="text" id="reg_student_id" class="input input-bordered w-full" />
                            </div>
                            <div class="form-control w-full">
                                <label class="label">
                                    <span class="label-text font-medium">Image</span>
                                </label>
                                <input type="file" id="reg_image" accept="image/*" 
                                       onchange="previewImage(this, 'reg_preview')" 
                                       class="file-input file-input-bordered w-full" />
                                <div class="mt-4 relative aspect-video bg-base-300 rounded-lg overflow-hidden">
                                    <img id="reg_preview" class="absolute inset-0 w-full h-full object-contain hidden" />
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <span class="material-icons-round text-4xl text-base-content/30">add_photo_alternate</span>
                                    </div>
                                </div>
                            </div>
                            <button onclick="registerFace()" class="btn btn-primary w-full gap-2">
                                <span class="material-icons-round">person_add</span>
                                Register Face
                            </button>
                        </div>
                        <div id="register_result" class="mt-3 hidden"></div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Recognize Face Form -->
                <div class="card bg-base-200 mt-6 hover-scale">
                    <div class="card-body">
                        <h3 class="card-title text-lg">
                            <span class="material-icons-round text-accent">face</span>
                            Recognize Face
                        </h3>
                        <div class="space-y-4">
                            {% if current_user.role != 'student' %}
                            <div class="form-control w-full">
                                <label class="label">
                                    <span class="label-text font-medium">Subject</span>
                                </label>
                                <select id="rec_subject_select" class="select select-bordered w-full">
                                    <option value="">-- Select Subject --</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                            <div class="form-control w-full">
                                <label class="label">
                                    <span class="label-text font-medium">Image</span>
                                </label>
                                <input type="file" id="rec_image" accept="image/*" 
                                       onchange="previewImage(this, 'rec_preview')" 
                                       class="file-input file-input-bordered w-full" />
                                <div class="mt-4 relative aspect-video bg-base-300 rounded-lg overflow-hidden">
                                    <img id="rec_preview" class="absolute inset-0 w-full h-full object-contain hidden" />
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <span class="material-icons-round text-4xl text-base-content/30">add_photo_alternate</span>
                                    </div>
                                </div>
                            </div>
                            <button onclick="recognizeFace()" class="btn btn-accent w-full gap-2">
                                <span class="material-icons-round">face</span>
                                Recognize Face
                            </button>
                        </div>
                        
                        <!-- Recognition Results -->
                        <div id="recognize_result" class="mt-6 hidden">
                            <div class="divider">Recognition Results</div>
                            <div id="results_container" class="space-y-4">
                                <!-- Results will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity Section -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title flex items-center gap-2 mb-6">
                    <span class="material-icons-round text-primary">history</span>
                    Recent Activity
                </h2>
                <div class="space-y-4">
                    {% if attendance_records %}
                    {% for record in attendance_records %}
                    <div class="card bg-base-200 hover-scale">
                        <div class="card-body py-4">
                            <div class="flex items-center gap-4">
                                <div class="avatar placeholder">
                                    <div class="bg-primary text-primary-content rounded-full w-12">
                                        <span class="text-lg">{{ record.name[0].upper() }}</span>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <p class="font-medium">{{ record.name }}</p>
                                    <p class="text-sm opacity-70">{{ record.subject_name }}</p>
                                    <p class="text-xs opacity-50">{{ record.timestamp }}</p>
                                </div>
                                <div>
                                    <div class="badge {% if record.status == 'PRESENT' %}badge-success{% elif record.status == 'ABSENT' %}badge-error{% else %}badge-warning{% endif %} badge-lg">
                                        {{ record.status }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-12 bg-base-200 rounded-box">
                        <span class="material-icons-round text-6xl text-base-content/30 mb-4">history</span>
                        <p class="text-base-content/50">No recent activity</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Face Recognition -->
<script>
function previewImage(input, previewId) {
    const preview = document.getElementById(previewId);
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
            preview.parentElement.querySelector('.material-icons-round').classList.add('hidden');
        }
        reader.readAsDataURL(file);
    }
}

function showResult(element, message, type = 'success') {
    element.innerHTML = `
        <div class="alert alert-${type} shadow-lg animate-fade-up">
            <div class="flex items-center gap-2">
                <span class="material-icons-round">
                    ${type === 'success' ? 'check_circle' : 'error'}
                </span>
                <span>${message}</span>
            </div>
        </div>
    `;
    element.classList.remove('hidden');
}

async function getBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

async function registerFace() {
    const name = document.getElementById('reg_name').value.trim();
    const studentId = document.getElementById('reg_student_id').value.trim();
    const file = document.getElementById('reg_image').files[0];
    const resultDiv = document.getElementById('register_result');
    
    if (!name || !studentId || !file) {
        showToast('Please fill in all fields', 'error');
        return;
    }
    
    try {
        const base64Image = await getBase64(file);
        const response = await fetch('/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                student_id: studentId,
                image: base64Image
            })
        });
        
        const data = await response.json();
        showToast(data.message || data.error, response.ok ? 'success' : 'error');
    } catch (error) {
        showToast('An error occurred while registering the face', 'error');
    }
}

async function recognizeFace() {
    const file = document.getElementById('rec_image').files[0];
    const subjectSelect = document.getElementById('rec_subject_select');
    const subjectId = subjectSelect ? subjectSelect.value : '';
    const resultDiv = document.getElementById('recognize_result');
    const resultsContainer = document.getElementById('results_container');
    
    if (!file) {
        showToast('Please select an image', 'error');
        return;
    }
    
    try {
        const base64Image = await getBase64(file);
        const response = await fetch('/recognize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image: base64Image,
                subject_id: subjectId
            })
        });
        
        const data = await response.json();
        
        // Show results container
        resultDiv.classList.remove('hidden');
        resultsContainer.innerHTML = '';
        
        // Add summary card
        resultsContainer.innerHTML += `
            <div class="card bg-base-300">
                <div class="card-body">
                    <h3 class="card-title text-lg">Summary</h3>
                    <p>${data.message}</p>
                </div>
            </div>
        `;
        
        // Add individual results
        if (data.identified_people && data.identified_people.length > 0) {
            data.identified_people.forEach((person, index) => {
                const card = document.createElement('div');
                card.className = 'card bg-base-300 animate-fade-up';
                card.style.animationDelay = `${index * 100}ms`;
                
                if (person.name && person.student_id) {
                    card.innerHTML = `
                        <div class="card-body">
                            <div class="flex items-center gap-4">
                                <div class="avatar placeholder">
                                    <div class="bg-primary text-primary-content rounded-full w-12">
                                        <span class="text-lg">${person.name[0].toUpperCase()}</span>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-medium">${person.name}</h3>
                                    <p class="text-sm opacity-70">ID: ${person.student_id}</p>
                                </div>
                                <div class="text-right">
                                    <div class="radial-progress text-primary" style="--value:${person.confidence};">
                                        ${Math.round(person.confidence)}%
                                    </div>
                                    <p class="text-xs opacity-50 mt-1">Confidence</p>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <span class="material-icons-round">warning</span>
                                <span>${person.message}</span>
                            </div>
                        </div>
                    `;
                }
                
                resultsContainer.appendChild(card);
            });
        }
    } catch (error) {
        showToast('An error occurred while recognizing faces', 'error');
    }
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} shadow-lg max-w-sm animate-fade-in fixed bottom-4 right-4 z-50`;
    
    const icon = document.createElement('span');
    icon.className = 'material-icons-round';
    icon.textContent = type === 'success' ? 'check_circle' :
                      type === 'error' ? 'error' :
                      type === 'warning' ? 'warning' :
                      'info';
    
    const text = document.createElement('span');
    text.textContent = message;
    
    toast.appendChild(icon);
    toast.appendChild(text);
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>
{% endblock %} 
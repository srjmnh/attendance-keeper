{% extends "base.html" %}

{% block title %}Register Face - Attendance System{% endblock %}

{% block styles %}
<style>
    .registration-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .registration-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .registration-title {
        font-size: 1.5rem;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }

    .registration-subtitle {
        color: var(--text-light);
        font-size: 0.9rem;
    }

    .registration-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .camera-section {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .camera-container {
        position: relative;
        width: 100%;
        aspect-ratio: 4/3;
        background-color: #000;
        border-radius: 10px;
        overflow: hidden;
    }

    #video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    #canvas {
        display: none;
    }

    .camera-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: 2px solid var(--primary-color);
        border-radius: 10px;
        pointer-events: none;
    }

    .camera-guide {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 200px;
        height: 200px;
        border: 2px solid var(--primary-color);
        border-radius: 50%;
        pointer-events: none;
    }

    .camera-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
    }

    .camera-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 5px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        outline: none;
    }

    .capture-button {
        background-color: var(--primary-color);
        color: white;
    }

    .capture-button:hover {
        background-color: var(--primary-dark);
    }

    .retake-button {
        background-color: var(--accent-color);
        color: white;
    }

    .retake-button:hover {
        background-color: var(--error-color);
    }

    .form-section {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .preview-container {
        width: 100%;
        aspect-ratio: 1;
        background-color: var(--background-color);
        border-radius: 10px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
    }

    #preview {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .quality-feedback {
        padding: 1rem;
        border-radius: 5px;
        margin-top: 1rem;
        font-size: 0.9rem;
    }

    .quality-good {
        background-color: var(--success-color);
        color: white;
    }

    .quality-warning {
        background-color: var(--warning-color);
        color: var(--text-color);
    }

    .quality-error {
        background-color: var(--error-color);
        color: white;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid var(--white);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    @media (max-width: 768px) {
        .registration-grid {
            grid-template-columns: 1fr;
        }

        .registration-container {
            margin: 1rem;
            padding: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="registration-container">
    <div class="registration-header">
        <h1 class="registration-title">Register New Face</h1>
        <p class="registration-subtitle">Take a clear photo and enter student details</p>
    </div>

    <div class="registration-grid">
        <div class="camera-section">
            <div class="camera-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
                <div class="camera-overlay"></div>
                <div class="camera-guide"></div>
            </div>
            <div class="camera-controls">
                <button id="capture" class="camera-button capture-button">
                    <i class="fas fa-camera"></i> Capture Photo
                </button>
                <button id="retake" class="camera-button retake-button" style="display: none;">
                    <i class="fas fa-redo"></i> Retake
                </button>
            </div>
        </div>

        <div class="form-section">
            <form id="registration-form" method="POST" action="{{ url_for('recognition.register_face') }}">
                {{ form.csrf_token }}

                <div class="preview-container">
                    <img id="preview" src="" alt="Preview" style="display: none;">
                </div>

                <div class="form-group">
                    <label class="form-label" for="student_id">Student ID</label>
                    {{ form.student_id(class="form-control", required=true) }}
                    {% if form.student_id.errors %}
                    <div class="form-error">
                        {% for error in form.student_id.errors %}
                        {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label class="form-label" for="name">Full Name</label>
                    {{ form.name(class="form-control", required=true) }}
                    {% if form.name.errors %}
                    <div class="form-error">
                        {% for error in form.name.errors %}
                        {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <input type="hidden" id="image_data" name="image_data">

                <div id="quality-feedback" class="quality-feedback" style="display: none;"></div>

                <button type="submit" class="btn btn-primary" style="width: 100%;" disabled>
                    <i class="fas fa-save"></i> Register Face
                </button>
            </form>
        </div>
    </div>
</div>

<div id="loading" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let stream;
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');
    const captureButton = document.getElementById('capture');
    const retakeButton = document.getElementById('retake');
    const registrationForm = document.getElementById('registration-form');
    const imageDataInput = document.getElementById('image_data');
    const qualityFeedback = document.getElementById('quality_feedback');
    const submitButton = registrationForm.querySelector('button[type="submit"]');
    const loading = document.getElementById('loading');

    // Start video stream
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: 'user'
                }
            });
            video.srcObject = stream;
        } catch (err) {
            console.error('Error accessing camera:', err);
            alert('Error accessing camera. Please make sure you have granted camera permissions.');
        }
    }

    // Initialize camera on page load
    startCamera();

    // Capture photo
    captureButton.addEventListener('click', async () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        const imageData = canvas.toDataURL('image/jpeg', 0.9);
        preview.src = imageData;
        preview.style.display = 'block';
        imageDataInput.value = imageData;

        // Show/hide buttons
        captureButton.style.display = 'none';
        retakeButton.style.display = 'inline-flex';
        submitButton.disabled = false;

        // Analyze image quality
        loading.style.display = 'flex';
        try {
            const response = await fetch("{{ url_for('recognition.analyze_image') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ image_data: imageData })
            });

            const data = await response.json();
            if (data.analysis) {
                qualityFeedback.textContent = data.analysis;
                qualityFeedback.style.display = 'block';
                
                if (data.analysis.toLowerCase().includes('good') || data.analysis.toLowerCase().includes('excellent')) {
                    qualityFeedback.className = 'quality-feedback quality-good';
                } else if (data.analysis.toLowerCase().includes('warning') || data.analysis.toLowerCase().includes('improve')) {
                    qualityFeedback.className = 'quality-feedback quality-warning';
                } else {
                    qualityFeedback.className = 'quality-feedback quality-error';
                }
            }
        } catch (err) {
            console.error('Error analyzing image:', err);
        } finally {
            loading.style.display = 'none';
        }
    });

    // Retake photo
    retakeButton.addEventListener('click', () => {
        preview.style.display = 'none';
        imageDataInput.value = '';
        captureButton.style.display = 'inline-flex';
        retakeButton.style.display = 'none';
        submitButton.disabled = true;
        qualityFeedback.style.display = 'none';
    });

    // Form submission
    registrationForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!imageDataInput.value) {
            alert('Please capture a photo first.');
            return;
        }

        loading.style.display = 'flex';
        try {
            const formData = new FormData(registrationForm);
            const response = await fetch(registrationForm.action, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            if (response.ok) {
                alert('Face registered successfully!');
                window.location.reload();
            } else {
                alert(data.error || 'Registration failed. Please try again.');
            }
        } catch (err) {
            console.error('Error submitting form:', err);
            alert('An error occurred. Please try again.');
        } finally {
            loading.style.display = 'none';
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
    });
</script>
{% endblock %} 
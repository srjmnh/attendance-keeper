<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() if csrf_token else '' }}">
    <title>Classroom Mode - AttendanceAI</title>
    
    <!-- Tailwind and DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.1/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: black;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .btn {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            font-weight: 500;
        }
        .stats {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
        }
        .alert {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
        }
        .logo-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.1);
            pointer-events: none;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="fixed inset-0 bg-black">
        <!-- Minimal Header -->
        <div class="absolute top-0 left-0 right-0 z-10 bg-black/50 backdrop-blur-sm border-b border-white/10">
            <div class="container mx-auto px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="text-white">
                        <h1 class="text-xl font-semibold tracking-tight">Classroom Mode</h1>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="stats bg-black/50 text-white border border-white/10 shadow-lg">
                            <div class="stat py-2 px-4">
                                <div class="stat-title text-xs font-medium opacity-60 uppercase tracking-wider">Unique Faces</div>
                                <div class="stat-value text-2xl font-semibold tracking-tight" id="faceCounter">0</div>
                            </div>
                        </div>
                        
                        <button onclick="showConfirmationModal()" id="confirmBtn" class="btn btn-success btn-sm gap-2 opacity-50 pointer-events-none shadow-lg" disabled>
                            <i class="ri-check-double-line"></i>
                            Confirm Attendance
                        </button>
                        
                        <div class="flex items-center gap-2">
                            <button id="switchCamera" class="btn btn-circle btn-sm bg-white/5 border-white/10 text-white hover:bg-white/10 hover:border-white/20">
                                <i class="ri-camera-switch-line"></i>
                            </button>
                            <button onclick="toggleFullscreen()" class="btn btn-circle btn-sm bg-white/5 border-white/10 text-white hover:bg-white/10 hover:border-white/20">
                                <i class="ri-fullscreen-line" id="fullscreenIcon"></i>
                            </button>
                            <a href="{{ url_for('main.dashboard') }}" class="btn btn-circle btn-sm bg-white/5 border-white/10 text-white hover:bg-white/10 hover:border-white/20">
                                <i class="ri-close-line"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="absolute inset-0 flex items-center justify-center">
            <!-- Camera Feed -->
            <video id="video" class="max-h-full w-auto object-contain" autoplay playsinline></video>
            <canvas id="canvas" class="hidden"></canvas>
            
            <!-- Logo Overlay -->
            <div class="logo-overlay">AttendanceAI</div>
            
            <!-- Face Detection Overlay -->
            <div id="faceOverlay" class="absolute inset-0 pointer-events-none"></div>
        </div>
        
        <!-- Status Messages -->
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 w-full max-w-3xl px-4">
            <div class="space-y-3">
                <div id="status" class="alert bg-black/50 text-white border border-white/10 shadow-lg py-2.5 backdrop-blur-sm">
                    <i class="ri-information-line text-lg"></i>
                    <span class="text-sm font-medium">Position students to detect faces</span>
                </div>
                
                <div id="detectedFaces" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-3 bg-black/50 backdrop-blur-sm rounded-lg border border-white/10 shadow-lg">
                    <!-- Detected faces will be shown here -->
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <dialog id="confirmationModal" class="modal">
            <div class="modal-box bg-black/90 text-white border border-white/10">
                <h3 class="font-bold text-lg mb-4">Confirm Attendance</h3>
                <div id="studentsList" class="space-y-3 max-h-96 overflow-y-auto mb-4">
                    <!-- Student details will be inserted here -->
                </div>
                <div class="modal-action">
                    <button onclick="closeConfirmationModal()" class="btn btn-ghost btn-sm">Cancel</button>
                    <button onclick="confirmAttendance()" class="btn btn-success btn-sm">Confirm</button>
                </div>
            </div>
            <form method="dialog" class="modal-backdrop">
                <button>close</button>
            </form>
        </dialog>
    </div>

<script>
let width = 1280;
let height = 0;
let streaming = false;
let video = null;
let canvas = null;
let switchCameraButton = null;
let confirmButton = null;
let stream = null;
let detectedStudents = new Map();
let processingFrame = false;
let lastProcessedTime = 0;
const PROCESS_INTERVAL = 1000; // Process every 1 second

function showMessage(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} fixed bottom-4 right-4 w-auto max-w-sm z-50 animate-fade-in`;
    toast.innerHTML = `
        <i class="ri-${type === 'success' ? 'checkbox-circle' : type === 'error' ? 'error-warning' : 'information'}-line"></i>
        <span>${message}</span>
    `;
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.classList.add('opacity-0');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function updateStatus(message, type = 'info') {
    const status = document.getElementById('status');
    status.className = `alert bg-black/50 text-white border-${type} shadow-lg py-2 backdrop-blur-sm animate-fade-in`;
    status.innerHTML = `<i class="ri-information-line"></i><span>${message}</span>`;
}

function drawFaceBox(face) {
    const overlay = document.getElementById('faceOverlay');
    const box = document.createElement('div');
    const { x, y, width: w, height: h } = face.boundingBox;
    
    // Change border color based on match status
    const borderColor = face.match ? (face.match.alreadyMarked ? 'border-warning' : 'border-success') : 'border-error';
    box.className = `absolute border-2 ${borderColor} rounded-lg transition-all duration-200 shadow-lg animate-fade-in`;
    box.style.left = `${x}px`;
    box.style.top = `${y}px`;
    box.style.width = `${w}px`;
    box.style.height = `${h}px`;
    
    if (face.match) {
        // Name label with attendance status
        const label = document.createElement('div');
        const bgColor = face.match.alreadyMarked ? 'bg-warning' : 'bg-success';
        label.className = `absolute -top-6 left-0 right-0 text-center ${bgColor} text-${bgColor}-content px-2 py-0.5 rounded-t-lg text-xs font-medium shadow-lg`;
        label.textContent = face.match.name + (face.match.alreadyMarked ? ' (Marked)' : '');
        box.appendChild(label);
        
        // Confidence label
        const confidence = document.createElement('div');
        confidence.className = 'absolute -bottom-6 left-0 right-0 text-center bg-black/50 backdrop-blur-sm text-white text-xs py-0.5 shadow-lg';
        confidence.textContent = `${Math.round(face.match.confidence)}%`;
        box.appendChild(confidence);
    }
    
    overlay.appendChild(box);
}

function clearFaceBoxes() {
    const overlay = document.getElementById('faceOverlay');
    overlay.innerHTML = '';
}

function updateDetectedFaces(faces) {
    const count = document.getElementById('faceCounter');
    const confirmBtn = document.getElementById('confirmBtn');
    
    // Clear previous faces
    detectedStudents.clear();
    
    faces.forEach(face => {
        if (face.match) {
            // Store only the highest confidence match for each student
            const existingMatch = detectedStudents.get(face.match.student_id);
            if (!existingMatch || face.match.confidence > existingMatch.confidence) {
                detectedStudents.set(face.match.student_id, face.match);
            }
        }
        // Draw face box
        drawFaceBox(face);
    });
    
    // Update counter and confirm button state
    const uniqueFaces = detectedStudents.size;
    count.textContent = uniqueFaces;
    
    if (uniqueFaces > 0) {
        confirmBtn.classList.remove('opacity-50', 'pointer-events-none');
        confirmBtn.disabled = false;
        updateStatus(`${uniqueFaces} student${uniqueFaces > 1 ? 's' : ''} detected`, 'success');
    } else {
        confirmBtn.classList.add('opacity-50', 'pointer-events-none');
        confirmBtn.disabled = true;
        updateStatus('Position students to detect faces');
    }
}

async function startup() {
    video = document.getElementById('video');
    canvas = document.getElementById('canvas');
    switchCameraButton = document.getElementById('switchCamera');
    confirmButton = document.getElementById('confirmBtn');

    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'user',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            },
            audio: false
        });
        video.srcObject = stream;
        video.play();
        
        // Request fullscreen on startup
        const container = document.documentElement;
        if (container.requestFullscreen) {
            container.requestFullscreen();
        } else if (container.webkitRequestFullscreen) {
            container.webkitRequestFullscreen();
        } else if (container.msRequestFullscreen) {
            container.msRequestFullscreen();
        }
        document.getElementById('fullscreenIcon').className = 'ri-fullscreen-exit-line';
    } catch (err) {
        showMessage('Error accessing camera: ' + err.message, 'error');
        console.error("An error occurred: " + err);
    }

    video.addEventListener('canplay', function() {
        if (!streaming) {
            height = video.videoHeight / (video.videoWidth / width);
            video.setAttribute('width', width);
            video.setAttribute('height', height);
            canvas.setAttribute('width', width);
            canvas.setAttribute('height', height);
            streaming = true;
            
            // Start face detection loop
            detectFaces();
        }
    }, false);

    switchCameraButton.addEventListener('click', switchCamera);
}

async function switchCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }

    try {
        const currentFacingMode = stream?.getVideoTracks()[0]?.getSettings()?.facingMode;
        stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: currentFacingMode === 'user' ? 'environment' : 'user',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            },
            audio: false
        });
        video.srcObject = stream;
        video.play();
    } catch (err) {
        showMessage('Error switching camera: ' + err.message, 'error');
        console.error("An error occurred: " + err);
    }
}

function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
}

async function detectFaces() {
    if (!streaming || processingFrame) return;
    
    const now = Date.now();
    if (now - lastProcessedTime < PROCESS_INTERVAL) {
        requestAnimationFrame(detectFaces);
        return;
    }
    
    processingFrame = true;
    lastProcessedTime = now;
    
    try {
        const context = canvas.getContext('2d');
        canvas.width = width;
        canvas.height = height;
        context.drawImage(video, 0, 0, width, height);
        
        // Get image data
        const imageData = canvas.toDataURL('image/jpeg', 0.8);
        
        // Send to server for face detection
        const response = await fetch("{{ url_for('recognition.detect_faces') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ image: imageData })
        });
        
        if (response.ok) {
            const result = await response.json();
            clearFaceBoxes();
            
            if (result.faces && result.faces.length > 0) {
                updateDetectedFaces(result.faces);
            } else {
                updateStatus('Position students to detect faces');
            }
        }
    } catch (error) {
        console.error('Error detecting faces:', error);
        updateStatus('Error detecting faces. Please try again.', 'error');
    } finally {
        processingFrame = false;
        requestAnimationFrame(detectFaces);
    }
}

function showConfirmationModal() {
    const modal = document.getElementById('confirmationModal');
    const studentsList = document.getElementById('studentsList');
    studentsList.innerHTML = '';

    // Create list of detected students
    detectedStudents.forEach(student => {
        const studentCard = document.createElement('div');
        studentCard.className = 'bg-white/5 rounded-lg p-3 border border-white/10';
        studentCard.innerHTML = `
            <div class="flex items-center justify-between">
                <div>
                    <h4 class="font-medium">${student.name}</h4>
                    <p class="text-sm opacity-60">ID: ${student.student_id}</p>
                </div>
                <div class="text-right">
                    <span class="text-xs font-medium opacity-60">Confidence</span>
                    <p class="text-sm font-medium">${Math.round(student.confidence)}%</p>
                </div>
            </div>
        `;
        studentsList.appendChild(studentCard);
    });

    modal.showModal();
}

function closeConfirmationModal() {
    const modal = document.getElementById('confirmationModal');
    modal.close();
}

async function confirmAttendance() {
    const confirmBtn = document.getElementById('confirmBtn');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i>Processing...';

    try {
        const response = await fetch('/mark_classroom_attendance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                students: Array.from(detectedStudents.values())
            })
        });

        const data = await response.json();
        if (response.ok) {
            showMessage(`${data.message}`, 'success');
            closeConfirmationModal();
            // Clear detected students after marking attendance
            detectedStudents.clear();
            // Reset UI
            clearFaceBoxes();
            document.getElementById('faceCounter').textContent = '0';
            updateStatus('Attendance marked successfully! Position new students to detect faces.', 'success');
        } else {
            throw new Error(data.error || 'Failed to mark attendance');
        }
    } catch (error) {
        console.error('Error marking attendance:', error);
        showMessage('Failed to mark attendance. Please try again.', 'error');
    } finally {
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="ri-check-double-line"></i>Confirm Attendance';
    }
}

// Fullscreen handling
function toggleFullscreen() {
    const container = document.documentElement;
    const icon = document.getElementById('fullscreenIcon');
    
    if (!document.fullscreenElement) {
        if (container.requestFullscreen) {
            container.requestFullscreen();
        } else if (container.webkitRequestFullscreen) {
            container.webkitRequestFullscreen();
        } else if (container.msRequestFullscreen) {
            container.msRequestFullscreen();
        }
        icon.className = 'ri-fullscreen-exit-line';
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
        icon.className = 'ri-fullscreen-line';
    }
}

// Handle fullscreen change event
document.addEventListener('fullscreenchange', function() {
    const icon = document.getElementById('fullscreenIcon');
    icon.className = document.fullscreenElement ? 'ri-fullscreen-exit-line' : 'ri-fullscreen-line';
});

// Start in fullscreen mode
window.addEventListener('load', startup, false);
</script>
</body>
</html> 
{% extends "base.html" %}

{% block title %}Take Attendance - Attendance System{% endblock %}

{% block styles %}
<style>
    .recognition-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .recognition-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .recognition-title {
        font-size: 1.5rem;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }

    .recognition-subtitle {
        color: var(--text-light);
        font-size: 0.9rem;
    }

    .recognition-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .camera-section {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .camera-container {
        position: relative;
        width: 100%;
        aspect-ratio: 4/3;
        background-color: #000;
        border-radius: 10px;
        overflow: hidden;
    }

    #video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    #canvas {
        display: none;
    }

    .camera-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: 2px solid var(--primary-color);
        border-radius: 10px;
        pointer-events: none;
    }

    .camera-guide {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 200px;
        height: 200px;
        border: 2px solid var(--primary-color);
        border-radius: 50%;
        pointer-events: none;
    }

    .camera-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
    }

    .camera-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 5px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        outline: none;
    }

    .capture-button {
        background-color: var(--primary-color);
        color: white;
    }

    .capture-button:hover {
        background-color: var(--primary-dark);
    }

    .retake-button {
        background-color: var(--accent-color);
        color: white;
    }

    .retake-button:hover {
        background-color: var(--error-color);
    }

    .results-section {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .preview-container {
        width: 100%;
        aspect-ratio: 1;
        background-color: var(--background-color);
        border-radius: 10px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
    }

    #preview {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .recognition-results {
        background-color: var(--background-color);
        border-radius: 10px;
        padding: 1rem;
    }

    .results-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .result-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        border-bottom: 1px solid var(--border-color);
    }

    .result-item:last-child {
        border-bottom: none;
    }

    .result-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
    }

    .result-info {
        flex-grow: 1;
    }

    .result-name {
        font-weight: 500;
        color: var(--text-color);
    }

    .result-id {
        font-size: 0.8rem;
        color: var(--text-light);
    }

    .result-confidence {
        font-size: 0.8rem;
        font-weight: 500;
        padding: 0.25rem 0.5rem;
        border-radius: 15px;
    }

    .confidence-high {
        background-color: var(--success-color);
        color: white;
    }

    .confidence-medium {
        background-color: var(--warning-color);
        color: var(--text-color);
    }

    .confidence-low {
        background-color: var(--error-color);
        color: white;
    }

    .subject-select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        font-size: 1rem;
        color: var(--text-color);
        background-color: white;
        margin-bottom: 1rem;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid var(--white);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    @media (max-width: 768px) {
        .recognition-grid {
            grid-template-columns: 1fr;
        }

        .recognition-container {
            margin: 1rem;
            padding: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="recognition-container">
    <div class="recognition-header">
        <h1 class="recognition-title">Take Attendance</h1>
        <p class="recognition-subtitle">Select a subject and capture a photo of the students</p>
    </div>

    <div class="recognition-grid">
        <div class="camera-section">
            <select id="subject" class="subject-select" required>
                <option value="">Select Subject</option>
                {% for subject in subjects %}
                <option value="{{ subject.id }}">{{ subject.name }}</option>
                {% endfor %}
            </select>

            <div class="camera-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
                <div class="camera-overlay"></div>
                <div class="camera-guide"></div>
            </div>

            <div class="camera-controls">
                <button id="capture" class="camera-button capture-button">
                    <i class="fas fa-camera"></i> Capture Photo
                </button>
                <button id="retake" class="camera-button retake-button" style="display: none;">
                    <i class="fas fa-redo"></i> Retake
                </button>
            </div>
        </div>

        <div class="results-section">
            <div class="preview-container">
                <img id="preview" src="" alt="Preview" style="display: none;">
            </div>

            <div class="recognition-results" style="display: none;">
                <h2>Recognition Results</h2>
                <ul class="results-list" id="results-list"></ul>
                <button id="mark-attendance" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                    <i class="fas fa-check"></i> Mark Attendance
                </button>
            </div>
        </div>
    </div>
</div>

<div id="loading" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let stream;
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');
    const captureButton = document.getElementById('capture');
    const retakeButton = document.getElementById('retake');
    const subjectSelect = document.getElementById('subject');
    const resultsContainer = document.querySelector('.recognition-results');
    const resultsList = document.getElementById('results-list');
    const markAttendanceButton = document.getElementById('mark-attendance');
    const loading = document.getElementById('loading');

    // Start video stream
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: 'user'
                }
            });
            video.srcObject = stream;
        } catch (err) {
            console.error('Error accessing camera:', err);
            alert('Error accessing camera. Please make sure you have granted camera permissions.');
        }
    }

    // Initialize camera on page load
    startCamera();

    // Capture photo
    captureButton.addEventListener('click', async () => {
        if (!subjectSelect.value) {
            alert('Please select a subject first.');
            return;
        }

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        const imageData = canvas.toDataURL('image/jpeg', 0.9);
        preview.src = imageData;
        preview.style.display = 'block';

        // Show/hide buttons
        captureButton.style.display = 'none';
        retakeButton.style.display = 'inline-flex';

        // Recognize faces
        loading.style.display = 'flex';
        try {
            const response = await fetch("{{ url_for('recognition.recognize_faces') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    image_data: imageData,
                    subject_id: subjectSelect.value
                })
            });

            const data = await response.json();
            if (response.ok) {
                displayResults(data.results);
            } else {
                alert(data.error || 'Recognition failed. Please try again.');
            }
        } catch (err) {
            console.error('Error recognizing faces:', err);
            alert('An error occurred. Please try again.');
        } finally {
            loading.style.display = 'none';
        }
    });

    // Retake photo
    retakeButton.addEventListener('click', () => {
        preview.style.display = 'none';
        captureButton.style.display = 'inline-flex';
        retakeButton.style.display = 'none';
        resultsContainer.style.display = 'none';
    });

    // Display recognition results
    function displayResults(results) {
        resultsList.innerHTML = '';
        results.forEach(result => {
            const li = document.createElement('li');
            li.className = 'result-item';
            
            const confidence = result.confidence * 100;
            const confidenceClass = confidence >= 90 ? 'confidence-high' :
                                  confidence >= 70 ? 'confidence-medium' :
                                  'confidence-low';

            li.innerHTML = `
                <div class="result-avatar">
                    ${result.name.charAt(0)}
                </div>
                <div class="result-info">
                    <div class="result-name">${result.name}</div>
                    <div class="result-id">${result.student_id}</div>
                </div>
                <span class="result-confidence ${confidenceClass}">
                    ${confidence.toFixed(1)}%
                </span>
            `;
            resultsList.appendChild(li);
        });

        resultsContainer.style.display = 'block';
    }

    // Mark attendance
    markAttendanceButton.addEventListener('click', async () => {
        if (!subjectSelect.value) {
            alert('Please select a subject first.');
            return;
        }

        loading.style.display = 'flex';
        try {
            const response = await fetch("{{ url_for('attendance.mark_attendance') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subject_id: subjectSelect.value,
                    image_data: preview.src
                })
            });

            const data = await response.json();
            if (response.ok) {
                alert('Attendance marked successfully!');
                window.location.reload();
            } else {
                alert(data.error || 'Failed to mark attendance. Please try again.');
            }
        } catch (err) {
            console.error('Error marking attendance:', err);
            alert('An error occurred. Please try again.');
        } finally {
            loading.style.display = 'none';
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
    });
</script>
{% endblock %} 